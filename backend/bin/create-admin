#!/usr/bin/env node
const { Client } = require('pg');
const { hashPin } = require('../src/lib/crypto');
const readline = require('readline');

const rl = readline.createInterface({ input: process.stdin, output: process.stdout });

function prompt(q) {
  return new Promise(res => rl.question(q, res));
}

(async () => {
  try {
    const name = await prompt('Admin name: ');
    const phone = await prompt('Phone number: ');
    const role = await prompt('Role (clerk/mca/admin): ');
    
    // Securely prompt for PIN without echo
    process.stdout.write('PIN (6 digits): ');
    process.stdin.setRawMode(true);
    let pin = '';
    process.stdin.on('data', (char) => {
      if (char === '\u0003') process.exit(1);
      if (char === '\r' || char === '\n') {
        process.stdin.setRawMode(false);
        process.stdout.write('\n');
        setup(name, phone, role, pin);
      } else {
        pin += char;
      }
    });
  } catch(err) {
    console.error(err);
    process.exit(1);
  }
})();

async function setup(name, phone, role, pin) {
  const db = new Client({
    connectionString: process.env.DB_URL || 'postgresql://localhost/voo_ward'
  });
  await db.connect();
  
  try {
    const pinHash = hashPin(pin);
    const res = await db.query(
      'INSERT INTO admin_users (name, phone, role, pin_hash) VALUES (, , , ) RETURNING id',
      [name, phone, role, pinHash]
    );
    console.log(JSON.stringify({ id: res.rows[0].id, created: true }));
    process.exit(0);
  } catch(err) {
    console.error(JSON.stringify({ error: err.message }));
    process.exit(1);
  } finally {
    await db.end();
  }
}
