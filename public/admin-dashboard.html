<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VOO Ward - Admin Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --bg-dark: #1a1a1a;
            --bg-card: rgba(30, 30, 30, 0.6); /* Clearer Glass */
            --primary: #FF8C00;
            --primary-light: #FFB347;
            --primary-dark: #E67700;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --info: #3b82f6;
            --text: #ffffff;
            --text-muted: rgba(255, 255, 255, 0.6);
            --border: rgba(255, 140, 0, 0.2);
        }
        body { font-family: 'Inter', sans-serif; background: var(--bg-dark); min-height: 100vh; color: var(--text); overflow-x: hidden; }
        .app-container { display: flex; min-height: 100vh; background: linear-gradient(135deg, #0d0d0d 0%, #1a1a1a 50%, #0d0d0d 100%); background-attachment: fixed; }
        .sidebar { width: 240px; background: var(--bg-card); backdrop-filter: blur(15px); border-right: 1px solid var(--border); padding: 20px 14px; display: flex; flex-direction: column; position: fixed; height: 100vh; z-index: 100; }
        .user-profile { display: flex; align-items: center; gap: 12px; padding: 12px; margin-bottom: 24px; }
        .user-avatar { width: 44px; height: 44px; background: linear-gradient(135deg, var(--primary), var(--primary-dark)); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; }
        .user-info h4 { font-size: 14px; font-weight: 600; }
        .user-info span { font-size: 12px; color: var(--primary); }
        .nav-item { display: flex; align-items: center; gap: 12px; padding: 12px 14px; border-radius: 10px; color: var(--text-muted); text-decoration: none; margin-bottom: 4px; transition: all 0.2s ease; cursor: pointer; font-size: 14px; }
        .nav-item:hover { background: rgba(255, 140, 0, 0.1); color: var(--text); }
        .nav-item.active { background: var(--primary); color: #000; font-weight: 500; }
        .nav-icon { width: 18px; font-size: 16px; }
        .logout-btn { margin-top: auto; padding: 12px 14px; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 10px; color: #ef4444; cursor: pointer; display: flex; align-items: center; gap: 10px; font-size: 14px; transition: all 0.2s; }
        .logout-btn:hover { background: rgba(239, 68, 68, 0.2); }
        .main-content { flex: 1; margin-left: 240px; padding: 24px 28px; overflow-y: auto; Min-height: 100vh; display: flex; flex-direction: column; align-items: stretch; background: transparent; }
        .page-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 24px; }
        .page-title { font-size: 26px; font-weight: 700; }
        .page { display: none; }
        .page.active { display: block; }
        .loading { display: flex; align-items: center; justify-content: center; padding: 60px; color: var(--text-muted); }
        .loading i { animation: spin 1s linear infinite; margin-right: 10px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 18px; margin-bottom: 24px; }
        .stat-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 14px; padding: 22px; transition: all 0.3s ease; }
        .stat-card:hover { transform: translateY(-3px); border-color: rgba(255, 140, 0, 0.4); }
        .stat-value { font-size: 28px; font-weight: 700; color: var(--primary); margin-bottom: 4px; }
        .stat-label { font-size: 13px; color: var(--text-muted); }
        .charts-row { display: grid; grid-template-columns: 1fr; gap: 20px; margin-bottom: 20px; }
        .charts-row-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .chart-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 14px; padding: 22px; }
        .chart-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; }
        .chart-title { font-size: 15px; font-weight: 600; }
        .chart-container { height: 220px; }
        .donut-container { display: flex; align-items: center; gap: 20px; }
        .donut-chart { width: 130px; height: 130px; }
        .donut-legend { display: flex; flex-direction: column; gap: 10px; }
        .legend-item { display: flex; align-items: center; gap: 8px; font-size: 13px; }
        .legend-dot { width: 10px; height: 10px; border-radius: 50%; }
        .filter-bar { display: flex; align-items: center; gap: 12px; margin-bottom: 20px; flex-wrap: wrap; }
        .filter-select { padding: 10px 14px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-size: 13px; cursor: pointer; }
        .filter-select:focus { outline: none; border-color: var(--primary); }
        .search-input { padding: 10px 14px 10px 36px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-size: 13px; width: 200px; }
        .search-wrapper { position: relative; }
        .search-wrapper i { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-muted); font-size: 13px; }
        .btn { padding: 10px 18px; border-radius: 8px; font-size: 13px; font-weight: 500; cursor: pointer; border: none; transition: all 0.2s ease; display: inline-flex; align-items: center; gap: 8px; }
        .btn-primary { background: var(--primary); color: #000; }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text); }
        .btn-outline:hover { border-color: var(--primary); }
        .data-table { width: 100%; background: var(--bg-card); border: 1px solid var(--border); border-radius: 14px; overflow: hidden; }
        .data-table table { width: 100%; border-collapse: collapse; }
        .data-table th, .data-table td { padding: 14px 16px; text-align: left; font-size: 13px; }
        .data-table th { background: rgba(255, 255, 255, 0.03); color: var(--text-muted); font-weight: 500; }
        .data-table tr { border-bottom: 1px solid rgba(255, 255, 255, 0.05); }
        .data-table tr:last-child { border-bottom: none; }
        .data-table tr:hover { background: rgba(255, 140, 0, 0.05); }
        .issue-image { width: 60px; height: 60px; border-radius: 8px; object-fit: cover; cursor: pointer; border: 2px solid var(--border); }
        .issue-image:hover { transform: scale(1.1); border-color: var(--primary); }
        .no-image { width: 60px; height: 60px; border-radius: 8px; background: rgba(255,255,255,0.05); display: flex; align-items: center; justify-content: center; color: var(--text-muted); }
        .badge { padding: 5px 10px; border-radius: 6px; font-size: 11px; font-weight: 500; display: inline-block; }
        .badge-pending { background: rgba(245, 158, 11, 0.2); color: #f59e0b; }
        .badge-progress { background: rgba(59, 130, 246, 0.2); color: #3b82f6; }
        .badge-resolved { background: rgba(16, 185, 129, 0.2); color: #10b981; }
        .badge-rejected { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
        .action-btn { width: 32px; height: 32px; border-radius: 8px; border: none; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; margin-right: 6px; transition: all 0.2s ease; font-size: 13px; }
        .action-btn.view { background: rgba(59, 130, 246, 0.2); color: #3b82f6; }
        .action-btn.edit { background: rgba(255, 140, 0, 0.2); color: #ff8c00; }
        .action-btn.approve { background: rgba(16, 185, 129, 0.2); color: #10b981; }
        .action-btn.delete { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
        .action-btn:hover { transform: scale(1.1); }
        .pagination { display: flex; align-items: center; justify-content: flex-end; gap: 8px; padding: 16px; }
        .page-btn { padding: 8px 12px; border-radius: 6px; border: 1px solid var(--border); background: transparent; color: var(--text); font-size: 12px; cursor: pointer; }
        .page-btn.active { background: var(--primary); color: #000; border-color: var(--primary); }
        .users-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 18px; }
        .user-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 14px; padding: 20px; display: flex; gap: 14px; transition: all 0.2s ease; }
        .user-card:hover { border-color: rgba(255, 140, 0, 0.4); transform: translateY(-2px); }
        .user-card-avatar { width: 50px; height: 50px; background: linear-gradient(135deg, var(--primary), var(--primary-dark)); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 18px; }
        .user-card-info { flex: 1; }
        .user-card-name { font-weight: 600; margin-bottom: 4px; }
        .user-card-detail { font-size: 12px; color: var(--text-muted); margin-bottom: 2px; }
        .announcement-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 14px; padding: 20px; margin-bottom: 14px; display: flex; justify-content: space-between; align-items: flex-start; }
        .announcement-content { flex: 1; }
        .announcement-title { font-weight: 600; margin-bottom: 6px; }
        .announcement-text { font-size: 13px; color: var(--text-muted); margin-bottom: 8px; }
        .announcement-meta { font-size: 11px; color: var(--text-muted); }
        .settings-section { background: var(--bg-card); border: 1px solid var(--border); border-radius: 14px; padding: 24px; margin-bottom: 20px; }
        .settings-title { font-size: 16px; font-weight: 600; margin-bottom: 20px; }
        .settings-row { display: flex; align-items: center; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid rgba(255, 255, 255, 0.05); }
        .settings-row:last-child { border-bottom: none; }
        .settings-label { font-size: 14px; }
        .settings-input { padding: 10px 14px; background: rgba(0, 0, 0, 0.3); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-size: 13px; width: 300px; }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); display: none; align-items: center; justify-content: center; z-index: 1000; }
        .modal-overlay.active { display: flex; }
        .modal { background: var(--bg-card); border: 1px solid var(--border); border-radius: 16px; padding: 28px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; }
        .modal-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; }
        .modal-title { font-size: 18px; font-weight: 600; }
        .modal-close { background: none; border: none; color: var(--text-muted); font-size: 24px; cursor: pointer; }
        .modal-body { margin-bottom: 20px; }
        .modal-footer { display: flex; gap: 12px; justify-content: flex-end; }
        .form-group { margin-bottom: 16px; }
        .form-group label { display: block; margin-bottom: 6px; font-size: 13px; color: var(--text-muted); }
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 10px 14px; background: rgba(0,0,0,0.3); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-size: 13px; }
        .form-group textarea { min-height: 100px; resize: vertical; }
        .image-modal img { max-width: 100%; max-height: 70vh; border-radius: 8px; }
        .toast { position: fixed; bottom: 20px; right: 20px; padding: 14px 20px; border-radius: 10px; color: #fff; font-size: 14px; z-index: 2000; animation: slideIn 0.3s ease; }
        .toast.success { background: var(--success); }
        .toast.error { background: var(--error); }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .debug-info { position: fixed; bottom: 10px; left: 10px; background: rgba(0,0,0,0.8); padding: 10px; border-radius: 8px; font-size: 11px; color: #888; max-width: 300px; z-index: 9999; }
        @media (max-width: 1200px) { .stats-grid { grid-template-columns: repeat(2, 1fr); } .charts-row-2 { grid-template-columns: 1fr; } }
        
        /* Mobile Responsive */
        @media (max-width: 768px) { 
            .sidebar { 
                position: fixed; 
                left: -250px; 
                top: 0;
                height: 100vh;
                z-index: 1000;
                transition: left 0.3s ease;
            }
            .sidebar.open { left: 0; }
            .main-content { margin-left: 0; padding: 16px; }
            .stats-grid { grid-template-columns: 1fr; gap: 12px; }
            .page-header { flex-direction: column; align-items: flex-start; gap: 12px; }
            .page-header h1 { font-size: 20px; }
            .filter-bar { flex-direction: column; align-items: stretch; }
            .filter-select, .search-input { width: 100%; }
            .data-table { overflow-x: auto; }
            .data-table table { min-width: 600px; }
            .charts-row, .charts-row-2 { grid-template-columns: 1fr; }
            .user-card { padding: 12px; }
            #chat .page-header + div { flex-direction: column; height: auto; }
            #chat .page-header + div > div:first-child { width: 100%; max-height: 150px; overflow-y: auto; }
        }
        
        /* Hamburger menu button */
        .mobile-menu-btn {
            display: none;
            position: fixed;
            top: 16px;
            left: 16px;
            z-index: 1001;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 14px;
            font-size: 18px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        @media (max-width: 768px) { .mobile-menu-btn { display: block; } }
        
        /* Overlay for mobile menu */
        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 999;
        }
        .sidebar-overlay.show { display: block; }
        
        /* Blink animation for recording */
        @keyframes blink { 0%, 50% { opacity: 1; } 51%, 100% { opacity: 0; } }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Mobile menu button -->
        <button class="mobile-menu-btn" onclick="toggleMobileMenu()"><i class="fas fa-bars"></i></button>
        <div class="sidebar-overlay" onclick="toggleMobileMenu()"></div>
        
        <aside class="sidebar">
            <div style="padding: 10px 12px 20px; border-bottom: 1px solid var(--border); margin-bottom: 16px; display: flex; align-items: center; gap: 10px;">
                <img src="/images/voo_logo.png" alt="VOO Ward" style="width: 40px; height: 40px; border-radius: 8px;" onerror="this.style.display='none'">
                <span style="font-weight: 700; font-size: 16px; color: var(--primary);">VOO Ward</span>
            </div>
            <div class="user-profile">
                <div class="user-avatar" id="userAvatar">--</div>
                <div class="user-info">
                    <h4 id="userName">Loading...</h4>
                    <span id="userRole">--</span>
                </div>
            </div>
            <nav>
                <a class="nav-item active" data-page="dashboard"><i class="fas fa-th-large nav-icon"></i> Dashboard</a>
                <a class="nav-item" data-page="issues"><i class="fas fa-exclamation-circle nav-icon"></i> Issues</a>
                <a class="nav-item" data-page="users"><i class="fas fa-users nav-icon"></i> Users</a>
                <a class="nav-item" data-page="announcements"><i class="fas fa-bullhorn nav-icon"></i> Announcements</a>
                <a class="nav-item" data-page="bursary"><i class="fas fa-graduation-cap nav-icon"></i> Bursary</a>
                <a class="nav-item" data-page="lostids"><i class="fas fa-id-card nav-icon"></i> Lost IDs</a>
                <a class="nav-item" data-page="feedback"><i class="fas fa-comments nav-icon"></i> Feedback</a>
                <a class="nav-item" data-page="chat"><i class="fas fa-comment-dots nav-icon"></i> Admin Chat <span id="chatBadge" style="display:none;background:var(--error);color:white;font-size:11px;padding:2px 6px;border-radius:10px;margin-left:auto;">0</span></a>
                <a class="nav-item" data-page="settings"><i class="fas fa-cog nav-icon"></i> Settings</a>
            </nav>
            <!-- Sidebar Footer -->
            <div style="margin-top:auto;text-align:center;">
                <a href="https://github.com/MusaMuthami1/voo-ward-ussd" target="_blank" title="View Source on GitHub" style="display:inline-block;transition:transform 0.2s;">
                    <img src="/images/custom_github_logo.png" alt="GitHub" style="width:160px;height:auto;border-radius:12px;box-shadow:0 4px 15px rgba(0,0,0,0.3);border:1px solid rgba(255,255,255,0.1);">
                </a>
                <div class="logout-btn" onclick="logout()" style="margin-top:10px;">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </div>
            </div>
        </aside>

        <main class="main-content">
            <!-- Dashboard -->
            <div id="dashboard" class="page active">
                <div class="page-header">
                    <h1 class="page-title">Dashboard</h1>
                    <div style="display:flex;align-items:center;gap:15px;">
                        <span id="lastUpdate" style="font-size:12px;color:var(--text-muted);"></span>
                        <!-- APP HEALTH INDICATOR -->
                        <div id="appHealth" style="display:flex;align-items:center;gap:6px;background:rgba(16,185,129,0.1);padding:6px 12px;border-radius:20px;border:1px solid rgba(16,185,129,0.2);">
                            <div style="width:8px;height:8px;background:var(--success);border-radius:50%;box-shadow:0 0 5px var(--success);"></div>
                            <span style="font-size:12px;font-weight:600;color:var(--success);">App Healthy</span>
                        </div>
                    </div>
                </div>
                <div class="stats-grid">
                    <div class="stat-card"><div class="stat-value" id="statTotalIssues">0</div><div class="stat-label">Total Issues</div></div>
                    <div class="stat-card"><div class="stat-value" id="statPending" style="color:#f59e0b;">0</div><div class="stat-label">Pending</div></div>
                    <div class="stat-card"><div class="stat-value" id="statResolved" style="color:#10b981;">0</div><div class="stat-label">Resolved</div></div>
                    <div class="stat-card"><div class="stat-value" id="statAnnouncements">0</div><div class="stat-label">Announcements</div></div>
                </div>
                <div class="charts-row">
                    <div class="chart-card">
                        <div class="chart-header"><span class="chart-title">Issues Over Time</span></div>
                        <div class="chart-container"><canvas id="issuesChart"></canvas></div>
                    </div>
                </div>
                <div class="charts-row-2">
                    <div class="chart-card">
                        <div class="chart-header"><span class="chart-title">Issues by Category</span></div>
                        <div class="chart-container" style="height:180px;"><canvas id="categoryChart"></canvas></div>
                    </div>
                    <div class="chart-card">
                        <div class="chart-header"><span class="chart-title">Status Distribution</span></div>
                        <div class="donut-container">
                            <div class="donut-chart"><canvas id="statusChart"></canvas></div>
                            <div class="donut-legend" id="statusLegend"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Issues -->
            <div id="issues" class="page">
                <div class="page-header"><h1 class="page-title">Issues</h1></div>
                <div class="filter-bar">
                    <select class="filter-select" id="filterStatus" onchange="filterIssues()">
                        <option value="">Status: All</option>
                        <option value="Pending">Pending</option>
                        <option value="In Progress">In Progress</option>
                        <option value="Resolved">Resolved</option>
                    </select>
                    <select class="filter-select" id="filterCategory" onchange="filterIssues()"><option value="">Category: All</option></select>
                    <div class="search-wrapper"><i class="fas fa-search"></i><input type="text" class="search-input" id="searchIssues" placeholder="Search..." oninput="filterIssues()"></div>
                    <button class="btn btn-outline" onclick="loadIssues()"><i class="fas fa-sync"></i> Refresh</button>
                    <button class="btn btn-primary" onclick="exportToCSV('issuesTable', 'issues_export')"><i class="fas fa-file-excel"></i> Export Excel</button>
                </div>
                <div class="data-table" id="issuesTable"><div class="loading"><i class="fas fa-spinner"></i> Loading issues...</div></div>
                <table id="issuesTableExport" style="display:none;"></table>
            </div>

            <!-- Users -->
            <div id="users" class="page">
                <div class="page-header"><h1 class="page-title">App Users</h1></div>
                <div class="stats-grid" style="margin-bottom:20px;">
                    <div class="stat-card"><div class="stat-value" id="statTotalUsers">0</div><div class="stat-label">Total Users</div></div>
                </div>
                <div class="filter-bar">
                    <div class="search-wrapper"><i class="fas fa-search"></i><input type="text" class="search-input" id="searchUsers" placeholder="Search users..." oninput="filterUsers()"></div>
                    <button class="btn btn-primary" onclick="exportToCSV('usersGrid', 'users_export')"><i class="fas fa-file-excel"></i> Export Excel</button>
                </div>
                <!-- Hidden table for export -->
                <table id="usersTableExport" style="display:none;"></table>
                <div class="users-grid" id="usersGrid"><div class="loading"><i class="fas fa-spinner"></i> Loading users...</div></div>
            </div>

            <!-- Announcements -->
            <div id="announcements" class="page">
                <div class="page-header"><h1 class="page-title">Announcements</h1><button class="btn btn-primary" onclick="showCreateAnnouncement()"><i class="fas fa-plus"></i> Create New</button></div>
                <div id="announcementsList"><div class="loading"><i class="fas fa-spinner"></i> Loading...</div></div>
            </div>

            <!-- Bursary -->
            <div id="bursary" class="page">
                <div class="page-header"><h1 class="page-title">Bursary Applications</h1></div>
                <div class="stats-grid" style="margin-bottom:20px;" id="bursaryStats"></div>
                <div class="data-table" id="bursaryTable"><div class="loading"><i class="fas fa-spinner"></i> Loading...</div></div>
            </div>

            <!-- Settings -->
            <div id="settings" class="page">
                <div class="page-header"><h1 class="page-title">Settings</h1></div>
                <div class="settings-section">
                    <h3 class="settings-title">Profile</h3>
                    <div class="settings-row"><span class="settings-label">Username</span><input type="text" class="settings-input" id="settingsUsername" readonly></div>
                    <div class="settings-row"><span class="settings-label">Full Name</span><input type="text" class="settings-input" id="settingsFullName" readonly></div>
                    <div class="settings-row"><span class="settings-label">Role</span><input type="text" class="settings-input" id="settingsRole" readonly></div>
                </div>
                <div class="settings-section">
                    <h3 class="settings-title">Change Password</h3>
                    <div class="settings-row"><span class="settings-label">Current Password</span><input type="password" class="settings-input" id="currentPassword"></div>
                    <div class="settings-row"><span class="settings-label">New Password</span><input type="password" class="settings-input" id="newPassword"></div>
                    <button class="btn btn-primary" onclick="changePassword()"><i class="fas fa-key"></i> Change Password</button>
                </div>
                <div class="settings-section">
                    <h3 class="settings-title" style="color:var(--error);">Danger Zone</h3>
                    <p style="color:var(--text-muted);margin-bottom:16px;font-size:13px;">Log out of your account</p>
                    <button class="btn" onclick="logout()" style="background:var(--error);color:white;"><i class="fas fa-sign-out-alt"></i> Logout</button>
                </div>
                <!-- STATUS LINK -->
                <div style="margin-top:30px;padding:16px;background:linear-gradient(135deg, rgba(16,185,129,0.15), rgba(16,185,129,0.05));border-radius:12px;border:1px solid var(--success);text-align:center;">
                    <a href="/status.html" target="_blank" style="color:var(--success);text-decoration:underline;font-size:16px;font-weight:600;">
                        <i class="fas fa-heartbeat"></i> System Status
                    </a>
                    <p style="color:var(--text-muted);font-size:12px;margin-top:6px;">Check system health and service uptime</p>
                </div>
            </div>


            <!-- Lost IDs -->
            <div id="lostids" class="page">
                <div class="page-header"><h1 class="page-title">Lost ID Reports</h1></div>
                <div class="filter-bar">
                    <select class="filter-select" id="filterLostIdStatus" onchange="filterLostIds()">
                        <option value="">Status: All</option>
                        <option value="pending">Pending</option>
                        <option value="found">Found</option>
                    </select>
                    <div class="search-wrapper">
                        <i class="fas fa-search"></i>
                        <input type="text" class="search-input" id="searchLostIds" placeholder="Search by name..." oninput="filterLostIds()">
                    </div>
                    <button class="btn btn-outline" onclick="loadLostIds()"><i class="fas fa-sync-alt"></i> Refresh</button>
                </div>
                <div class="data-table">
                    <table>
                        <thead>
                            <tr>
                                <th>ID Owner</th>
                                <th>ID Number</th>
                                <th>Reporter</th>
                                <th>Location</th>
                                <th>Date Lost</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="lostIdsTable">
                            <tr><td colspan="7" class="loading"><i class="fas fa-spinner fa-spin"></i> Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Feedback -->
            <div id="feedback" class="page">
                <div class="page-header"><h1 class="page-title">User Feedback</h1></div>
                <div class="filter-bar">
                    <select class="filter-select" id="filterFeedbackStatus" onchange="filterFeedback()">
                        <option value="">Status: All</option>
                        <option value="new">New</option>
                        <option value="responded">Responded</option>
                    </select>
                    <select class="filter-select" id="filterFeedbackCategory" onchange="filterFeedback()">
                        <option value="">Category: All</option>
                        <option value="app">App</option>
                        <option value="services">Services</option>
                        <option value="suggestions">Suggestions</option>
                        <option value="general">General</option>
                    </select>
                    <button class="btn btn-outline" onclick="loadFeedback()"><i class="fas fa-sync-alt"></i> Refresh</button>
                </div>
                <div class="data-table">
                    <table>
                        <thead>
                            <tr>
                                <th>User</th>
                                <th>Category</th>
                                <th>Message</th>
                                <th>Rating</th>
                                <th>Status</th>
                                <th>Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="feedbackTable">
                            <tr><td colspan="7" class="loading"><i class="fas fa-spinner fa-spin"></i> Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Admin Chat -->
            <div id="chat" class="page">
                <div class="page-header"><h1 class="page-title">Admin Chat</h1><span id="chatStatus" style="font-size:12px;color:var(--text-muted);margin-left:12px;">Connecting...</span></div>
                <div style="display:flex;gap:16px;height:calc(100vh - 180px);">
                    <!-- Online Users -->
                    <div style="width:200px;background:var(--card-bg);border-radius:12px;padding:16px;border:1px solid var(--border);">
                        <h3 style="margin:0 0 12px;font-size:14px;color:var(--text-muted);">Online Users</h3>
                        <div id="onlineUsersList" style="display:flex;flex-direction:column;gap:8px;"></div>
                    </div>
                    <!-- Chat Messages -->
                    <div style="flex:1;display:flex;flex-direction:column;background:var(--card-bg);border-radius:12px;border:1px solid var(--border);overflow:hidden;">
                        <div id="chatMessages" style="flex:1;overflow-y:auto;padding:16px;display:flex;flex-direction:column;gap:12px;"></div>
                        <div id="typingIndicator" style="padding:0 16px;font-size:12px;color:var(--text-muted);height:20px;"></div>
                        <!-- Mentions dropdown -->
                        <div id="mentionsDropdown" style="display:none;position:absolute;bottom:80px;left:230px;background:var(--card-bg);border:1px solid var(--border);border-radius:8px;max-height:150px;overflow-y:auto;z-index:100;min-width:200px;"></div>
                        <!-- Image preview -->
                        <div id="chatImagePreview" style="display:none;padding:8px 16px;border-top:1px solid var(--border);">
                            <div style="display:flex;align-items:center;gap:8px;">
                                <img id="chatPreviewImg" src="" style="max-height:60px;border-radius:8px;">
                                <button onclick="clearChatImage()" style="background:var(--error);color:white;border:none;border-radius:4px;padding:4px 8px;cursor:pointer;"><i class="fas fa-times"></i></button>
                            </div>
                        </div>
                        <!-- Voice recording indicator -->
                        <div id="voiceRecordingIndicator" style="display:none;padding:8px 16px;border-top:1px solid var(--border);color:var(--error);">
                            <i class="fas fa-circle" style="animation:blink 1s infinite;"></i> Recording... <span id="recordingTime">0:00</span>
                            <button onclick="stopVoiceRecording()" style="margin-left:12px;background:var(--error);color:white;border:none;border-radius:4px;padding:4px 12px;cursor:pointer;">Stop</button>
                        </div>
                        <div style="padding:12px;border-top:1px solid var(--border);display:flex;gap:8px;align-items:center;">
                            <input type="file" id="chatImageInput" accept="image/*" style="display:none;" onchange="handleChatImageSelect(event)">
                            <button onclick="document.getElementById('chatImageInput').click()" title="Upload Image" style="padding:10px;background:var(--border);color:var(--text);border:none;border-radius:8px;cursor:pointer;"><i class="fas fa-image"></i></button>
                            <button id="voiceBtn" onclick="toggleVoiceRecording()" title="Voice Note" style="padding:10px;background:var(--border);color:var(--text);border:none;border-radius:8px;cursor:pointer;"><i class="fas fa-microphone"></i></button>
                            <input type="text" id="chatInput" placeholder="Type a message... Use @ to mention" style="flex:1;padding:12px;border-radius:8px;border:1px solid var(--border);background:var(--bg);color:var(--text);font-size:14px;" onkeydown="handleChatKeydown(event)" oninput="handleChatInput(event)">
                            <button onclick="sendChatMessage()" style="padding:12px 20px;background:var(--primary);color:white;border:none;border-radius:8px;cursor:pointer;font-weight:600;"><i class="fas fa-paper-plane"></i></button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div class="modal-overlay" id="imageModal">
        <div class="modal image-modal">
            <div class="modal-header"><span class="modal-title">Issue Image</span><button class="modal-close" onclick="closeModal('imageModal')">&times;</button></div>
            <div class="modal-body"><img id="modalImage" src="" alt="Issue Image"></div>
        </div>
    </div>

    <div class="modal-overlay" id="issueModal">
        <div class="modal">
            <div class="modal-header"><span class="modal-title">Update Issue Status</span><button class="modal-close" onclick="closeModal('issueModal')">&times;</button></div>
            <div class="modal-body" id="issueModalBody"></div>
            <div class="modal-footer">
                <select id="issueStatusSelect" class="filter-select" style="width:150px;">
                    <option value="Pending">Pending</option>
                    <option value="In Progress">In Progress</option>
                    <option value="Resolved">Resolved</option>
                </select>
                <input type="text" id="issueActionNote" class="settings-input" placeholder="Action note..." style="width:200px;">
                <button class="btn btn-primary" onclick="updateIssueStatus()"><i class="fas fa-save"></i> Update</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="announcementModal">
        <div class="modal">
            <div class="modal-header"><span class="modal-title">Create Announcement</span><button class="modal-close" onclick="closeModal('announcementModal')">&times;</button></div>
            <div class="modal-body">
                <div class="form-group"><label>Title</label><input type="text" id="annTitle" placeholder="Announcement title..."></div>
                <div class="form-group"><label>Message</label><textarea id="annBody" placeholder="Announcement message..."></textarea></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('announcementModal')">Cancel</button>
                <button class="btn btn-primary" onclick="createAnnouncement()"><i class="fas fa-paper-plane"></i> Publish</button>
            </div>
        </div>
    </div>

    <div id="debugInfo" class="debug-info" style="display:none;"></div>

    <script>
        // Config - IMPORTANT: Use /admin prefix as per the backend routing
        const API_BASE = window.location.origin;
        let authToken = localStorage.getItem('authToken');
        let currentUser = JSON.parse(localStorage.getItem('currentUser') || 'null');
        let allIssues = [];
        let allUsers = [];
        let allBursaries = [];
        let currentIssueId = null;
        let chartsInitialized = false;

        // Debug function
        function debug(msg) {
            console.log('[Dashboard]', msg);
            const d = document.getElementById('debugInfo');
            if (d) d.innerHTML = msg + '<br>' + d.innerHTML.substring(0, 500);
        }

        // Mobile menu toggle
        function toggleMobileMenu() {
            document.querySelector('.sidebar').classList.toggle('open');
            document.querySelector('.sidebar-overlay').classList.toggle('show');
        }
        
        // Close mobile menu when nav item clicked
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', () => {
                    if (window.innerWidth <= 768) {
                        document.querySelector('.sidebar').classList.remove('open');
                        document.querySelector('.sidebar-overlay').classList.remove('show');
                    }
                });
            });
        });
        
        // Download image for opening in native app
        function downloadImage(dataUrl, filename = 'chat_image.png') {
            const link = document.createElement('a');
            link.href = dataUrl;
            link.download = filename;
            link.click();
        }

        // XSS Protection - escape HTML in user data
        function escapeHtml(str) {
            if (!str) return '';
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        // Validate image URL to prevent javascript: URLs
        function safeImageUrl(url) {
            if (!url) return '';
            if (url.startsWith('javascript:') || url.startsWith('data:text')) return '';
            return url;
        }

        // Check auth
        if (!authToken) {
            debug('No auth token, redirecting to login');
            window.location.href = '/login.html';
        } else {
            debug('Auth token found: ' + authToken.substring(0,20) + '...');
        }

        // Toast
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // Modals
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }
        function openModal(id) { document.getElementById(id).classList.add('active'); }

        // Logout
        function logout() {
            localStorage.removeItem('authToken');
            localStorage.removeItem('currentUser');
            window.location.href = '/login.html';
        }

        // API helper
        async function api(endpoint, options = {}) {
            const headers = { 'Content-Type': 'application/json', ...options.headers };
            if (authToken) headers['Authorization'] = `Bearer ${authToken}`;
            
            const url = `${API_BASE}${endpoint}`;
            debug('API Call: ' + url);
            
            try {
                const res = await fetch(url, { ...options, headers });
                debug('API Response: ' + res.status);
                
                if (res.status === 401) { 
                    debug('Unauthorized - logging out');
                    logout(); 
                    return null; 
                }
                
                const data = await res.json();
                return data;
            } catch (err) {
                debug('API Error: ' + err.message);
                console.error('API Error:', err);
                return null;
            }
        }

        // Load user info
        function loadUserInfo() {
            if (currentUser) {
                document.getElementById('userName').textContent = currentUser.full_name || currentUser.username || 'Admin';
                document.getElementById('userRole').textContent = currentUser.role || 'MCA';
                document.getElementById('userAvatar').textContent = (currentUser.full_name || currentUser.username || 'A').slice(0,2).toUpperCase();
                document.getElementById('settingsUsername').value = currentUser.username || '';
                document.getElementById('settingsFullName').value = currentUser.full_name || '';
                document.getElementById('settingsRole').value = currentUser.role || '';
                debug('User loaded: ' + currentUser.username);
            }
        }

        // Load Dashboard
        async function loadDashboard() {
            debug('Loading dashboard data...');
            
            const [issues, announcements] = await Promise.all([
                api('/api/admin/issues'),
                api('/api/admin/announcements')
            ]);
            
            if (issues && Array.isArray(issues)) {
                allIssues = issues;
                debug('Issues loaded: ' + issues.length);
                
                // Case-insensitive status filtering
                const pending = issues.filter(i => !i.status || i.status.toLowerCase() === 'pending').length;
                const resolved = issues.filter(i => i.status && i.status.toLowerCase() === 'resolved').length;
                
                document.getElementById('statTotalIssues').textContent = issues.length;
                document.getElementById('statPending').textContent = pending;
                document.getElementById('statResolved').textContent = resolved;
                
                if (!chartsInitialized) {
                    updateCharts(issues);
                    chartsInitialized = true;
                }
            } else {
                debug('Failed to load issues: ' + JSON.stringify(issues));
            }
            
            if (announcements && Array.isArray(announcements)) {
                document.getElementById('statAnnouncements').textContent = announcements.length;
            }
            
            if (issues && Array.isArray(issues)) {
                // ... (existing code)
            }
            
            // Check App Health (Simulated check or based on data fetch success)
            const appHealthEl = document.getElementById('appHealth');
            if (issues && announcements) { // If both fetches succeeded
                appHealthEl.style.background = 'rgba(16,185,129,0.1)';
                appHealthEl.style.borderColor = 'rgba(16,185,129,0.2)';
                appHealthEl.innerHTML = '<div style="width:8px;height:8px;background:var(--success);border-radius:50%;box-shadow:0 0 8px var(--success);"></div><span style="font-size:12px;font-weight:600;color:var(--success);">App Healthy</span>';
            } else {
                 appHealthEl.style.background = 'rgba(239,68,68,0.1)';
                 appHealthEl.style.borderColor = 'rgba(239,68,68,0.2)';
                 appHealthEl.innerHTML = '<div style="width:8px;height:8px;background:var(--error);border-radius:50%;"></div><span style="font-size:12px;font-weight:600;color:var(--error);">Issues Detected</span>';
            }
            
            document.getElementById('lastUpdate').textContent = 'Updated: ' + new Date().toLocaleTimeString();
        }

        // Update Charts
        function updateCharts(issues) {
            const categories = {};
            issues.forEach(i => {
                const cat = i.category || 'Other';
                categories[cat] = (categories[cat] || 0) + 1;
            });

            const statuses = { Pending: 0, 'In Progress': 0, Resolved: 0 };
            issues.forEach(i => {
                const s = i.status || 'Pending';
                if (statuses.hasOwnProperty(s)) statuses[s]++;
                else statuses['Pending']++;
            });

            const days = [], counts = [];
            for (let i = 6; i >= 0; i--) {
                const d = new Date();
                d.setDate(d.getDate() - i);
                const dateStr = d.toISOString().slice(0,10);
                days.push(d.toLocaleDateString('en', { weekday: 'short' }));
                counts.push(issues.filter(x => x.created_at && x.created_at.slice(0,10) === dateStr).length);
            }

            // Issues over time chart
            const issuesCtx = document.getElementById('issuesChart');
            if (issuesCtx) {
                const gradient = issuesCtx.getContext('2d').createLinearGradient(0, 0, 0, 220);
                gradient.addColorStop(0, 'rgba(255, 140, 0, 0.3)');
                gradient.addColorStop(1, 'rgba(255, 140, 0, 0)');
                new Chart(issuesCtx, {
                    type: 'line',
                    data: { labels: days, datasets: [{ data: counts, borderColor: '#FF8C00', backgroundColor: gradient, borderWidth: 3, fill: true, tension: 0.4, pointRadius: 4, pointBackgroundColor: '#FF8C00' }] },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: 'rgba(255,255,255,0.5)' } }, y: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: 'rgba(255,255,255,0.5)' } } } }
                });
            }

            // Category chart
            const categoryCtx = document.getElementById('categoryChart');
            if (categoryCtx && Object.keys(categories).length > 0) {
                new Chart(categoryCtx, {
                    type: 'bar',
                    data: { labels: Object.keys(categories), datasets: [{ data: Object.values(categories), backgroundColor: '#FF8C00', borderRadius: 6, barThickness: 20 }] },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { grid: { display: false }, ticks: { color: 'rgba(255,255,255,0.5)' } }, y: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: 'rgba(255,255,255,0.5)' } } } }
                });
            }

            // Status donut chart
            const statusCtx = document.getElementById('statusChart');
            if (statusCtx) {
                const colors = { Pending: '#f59e0b', 'In Progress': '#3b82f6', Resolved: '#10b981' };
                new Chart(statusCtx, {
                    type: 'doughnut',
                    data: { labels: Object.keys(statuses), datasets: [{ data: Object.values(statuses), backgroundColor: Object.keys(statuses).map(k => colors[k]), borderWidth: 0, cutout: '70%' }] },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
                });
                document.getElementById('statusLegend').innerHTML = Object.entries(statuses).map(([k,v]) => `<div class="legend-item"><span class="legend-dot" style="background:${colors[k]};"></span>${k}: ${v}</div>`).join('');
            }
        }

        // Load Issues
        async function loadIssues() {
            debug('Loading issues...');
            document.getElementById('issuesTable').innerHTML = '<div class="loading"><i class="fas fa-spinner"></i> Loading issues...</div>';
            
            const issues = await api('/api/admin/issues');
            if (issues && Array.isArray(issues)) {
                allIssues = issues;
                debug('Issues loaded for table: ' + issues.length);
                
                // Populate categories filter
                const cats = [...new Set(issues.map(i => i.category).filter(Boolean))];
                document.getElementById('filterCategory').innerHTML = '<option value="">Category: All</option>' + cats.map(c => `<option value="${c}">${c}</option>`).join('');
                
                renderIssues(issues);
            } else {
                document.getElementById('issuesTable').innerHTML = '<p style="padding:20px;color:var(--text-muted);">No issues found or failed to load.</p>';
            }
        }

        function renderIssues(issues) {
            const statusBadge = (s) => {
                if (s === 'Resolved') return '<span class="badge badge-resolved">Resolved</span>';
                if (s === 'In Progress') return '<span class="badge badge-progress">In Progress</span>';
                return '<span class="badge badge-pending">Pending</span>';
            };

            let exportHtml = '<thead><tr><th>Ticket</th><th>Category</th><th>Description</th><th>Location</th><th>Status</th><th>Date Reported</th><th>Date Resolved</th><th>Action Note</th></tr></thead><tbody>';
            let html = `<table><thead><tr><th>Image</th><th>Ticket</th><th>Category</th><th>Description</th><th>Location</th><th>Status</th><th>Date</th><th>Actions</th></tr></thead><tbody>`;
            
            if (issues.length === 0) {
                html += '<tr><td colspan="8" style="text-align:center;padding:40px;color:var(--text-muted);">No issues found</td></tr>';
            } else {
                issues.forEach(issue => {
                    const img = safeImageUrl(issue.image_url || issue.imageUrl || issue.image);
                    let imgHtml;
                    if (img) {
                        imgHtml = `<img src="${escapeHtml(img)}" class="issue-image" onclick="viewImage('${escapeHtml(img)}')" alt="Issue" onerror="this.style.display='none';this.nextElementSibling.style.display='flex';">
                                   <div class="no-image" style="display:none;"><i class="fas fa-image"></i></div>`;
                    } else {
                        imgHtml = '<div class="no-image"><i class="fas fa-image"></i></div>';
                    }
                    const date = issue.created_at ? new Date(issue.created_at).toLocaleDateString() : '--';
                    const resolvedDate = issue.resolved_at ? new Date(issue.resolved_at).toLocaleString() : '--';
                    const desc = escapeHtml((issue.description || '').substring(0, 40) + ((issue.description || '').length > 40 ? '...' : ''));
                    
                    // Main Table Row
                    html += `<tr>
                        <td>${imgHtml}</td>
                        <td><strong>${escapeHtml(issue.ticket) || '--'}</strong></td>
                        <td>${escapeHtml(issue.category) || '--'}</td>
                        <td>${desc}</td>
                        <td>${escapeHtml(issue.location) || '--'}</td>
                        <td>${statusBadge(issue.status)}</td>
                        <td>${date}</td>
                        <td>
                            <button class="action-btn view" onclick="viewIssue('${escapeHtml(issue.ticket)}')" title="View"><i class="fas fa-eye"></i></button>
                            <select class="status-dropdown" onchange="setIssueStatus('${escapeHtml(issue._id || issue.id)}', this.value)" style="padding:6px;border-radius:6px;border:1px solid var(--border);background:var(--bg-card);color:var(--text);cursor:pointer;">
                                <option value="" disabled selected>Change Status</option>
                                <option value="Pending" ${(issue.status || 'Pending').toLowerCase() === 'pending' ? 'disabled' : ''}>Pending</option>
                                <option value="In Progress" ${(issue.status || '').toLowerCase() === 'in progress' ? 'disabled' : ''}>In Progress</option>
                                <option value="Resolved" ${(issue.status || '').toLowerCase() === 'resolved' ? 'disabled' : ''}>Resolved</option>
                            </select>
                            ${(issue.status || '').toLowerCase() === 'resolved' ? `<button class="action-btn" style="background:var(--error);color:white;" onclick="deleteIssue('${escapeHtml(issue._id || issue.id)}')" title="Delete"><i class="fas fa-trash"></i></button>` : ''}
                        </td>
                    </tr>`;

                    // Export Table Row
                    exportHtml += `<tr>
                        <td>${escapeHtml(issue.ticket || '--')}</td>
                        <td>${escapeHtml(issue.category || '--')}</td>
                        <td>${escapeHtml(issue.description || '--')}</td>
                        <td>${escapeHtml(issue.location || '--')}</td>
                        <td>${issue.status || 'Pending'}</td>
                        <td>${date}</td>
                        <td>${resolvedDate}</td>
                        <td>${escapeHtml(issue.resolution_notes || issue.action_note || '')}</td>
                    </tr>`;
                });
            }
            html += '</tbody></table>';
            document.getElementById('issuesTable').innerHTML = html;
            document.getElementById('issuesTableExport').innerHTML = exportHtml + '</tbody>';
        }

        function filterIssues() {
            const status = document.getElementById('filterStatus').value;
            const category = document.getElementById('filterCategory').value;
            const search = document.getElementById('searchIssues').value.toLowerCase();
            let filtered = allIssues;
            if (status) filtered = filtered.filter(i => i.status === status);
            if (category) filtered = filtered.filter(i => i.category === category);
            if (search) filtered = filtered.filter(i => 
                (i.description || '').toLowerCase().includes(search) || 
                (i.ticket || '').toLowerCase().includes(search) || 
                (i.location || '').toLowerCase().includes(search)
            );
            renderIssues(filtered);
        }

        function viewImage(url) {
            document.getElementById('modalImage').src = url;
            openModal('imageModal');
        }

        function viewIssue(ticket) {
            const issue = allIssues.find(i => i.ticket === ticket);
            if (!issue) return;
            currentIssueId = ticket;
            const img = issue.image_url || issue.imageUrl || issue.image;
            document.getElementById('issueModalBody').innerHTML = `
                ${img ? `<img src="${img}" style="width:100%;max-height:250px;object-fit:cover;border-radius:10px;margin-bottom:16px;">` : ''}
                <p><strong>Ticket:</strong> ${issue.ticket}</p>
                <p><strong>Category:</strong> ${issue.category || '--'}</p>
                <p><strong>Description:</strong> ${issue.description || '--'}</p>
                <p><strong>Location:</strong> ${issue.location || '--'}</p>
                <p><strong>Reporter:</strong> ${issue.phone_number || issue.reporter_name || '--'}</p>
                <p><strong>Current Status:</strong> ${issue.status || 'Pending'}</p>
                ${issue.action_note ? `<p><strong>Action Note:</strong> ${issue.action_note}</p>` : ''}
            `;
            document.getElementById('issueStatusSelect').value = issue.status || 'Pending';
            document.getElementById('issueActionNote').value = '';
            openModal('issueModal');
        }

        async function updateIssueStatus() {
            const status = document.getElementById('issueStatusSelect').value;
            const note = document.getElementById('issueActionNote').value;
            debug('Updating issue ' + currentIssueId + ' to ' + status);
            
            const res = await api(`/api/admin/issues/${currentIssueId}`, {
                method: 'PATCH',
                body: JSON.stringify({ status, action_note: note })
            });
            
            if (res && res.success) {
                showToast('Issue updated successfully!');
                closeModal('issueModal');
                loadIssues();
                loadDashboard();
            } else {
                showToast(res?.error || 'Failed to update', 'error');
            }
        }

        async function quickResolve(ticket) {
            if (!confirm('Mark issue ' + ticket + ' as Resolved?')) return;
            debug('Quick resolving ' + ticket);
            
            const res = await api(`/api/admin/issues/${ticket}`, {
                method: 'PATCH',
                body: JSON.stringify({ status: 'Resolved', action_note: 'Resolved by admin' })
            });
            
            if (res && res.success) {
                showToast('Issue resolved!');
                loadIssues();
                loadDashboard();
            } else {
                showToast(res?.error || 'Failed to resolve', 'error');
            }
        }

        // Set issue to a specific status (for stage progression)
        async function setIssueStatus(ticket, newStatus) {
            debug(`Setting issue ${ticket} to ${newStatus}`);
            
            const res = await api(`/api/admin/issues/${ticket}`, {
                method: 'PATCH',
                body: JSON.stringify({ status: newStatus, action_note: `Status changed to ${newStatus}` })
            });
            
            if (res && res.success) {
                showToast(`Issue marked as ${newStatus}!`);
                loadIssues();
                loadDashboard();
            } else {
                showToast(res?.error || 'Failed to update status', 'error');
            }
        }

        // Delete Issue
        async function deleteIssue(issueId) {
            if (!confirm('Are you sure you want to delete this resolved issue?')) return;
            
            const res = await api(`/api/admin/issues/${issueId}`, { method: 'DELETE' });
            
            if (res && res.success) {
                showToast('Issue deleted successfully');
                loadIssues();
                loadDashboard();
            } else {
                showToast(res?.error || 'Failed to delete issue', 'error');
            }
        }

        // Load Users
        async function loadUsers() {
            debug('Loading users...');
            const users = await api('/api/admin/app-users');
            if (users && Array.isArray(users)) {
                allUsers = users;
                document.getElementById('statTotalUsers').textContent = users.length;
                renderUsers(users);
            } else {
                document.getElementById('usersGrid').innerHTML = '<p style="padding:20px;color:var(--text-muted);">No users found or not authorized.</p>';
            }
        }

        function renderUsers(users) {
            // Populate hidden table for export
            let tableHtml = '<thead><tr><th>Name</th><th>Phone</th><th>Location</th><th>Joined</th></tr></thead><tbody>';
            let html = '';
            
            users.forEach(u => {
                const initials = escapeHtml((u.full_name || u.name || 'U').split(' ').map(n => n[0]).join('').slice(0,2).toUpperCase());
                const date = u.created_at ? new Date(u.created_at).toLocaleDateString() : '--';
                
                // Grid card
                html += `<div class="user-card">
                    <div class="user-card-avatar">${initials}</div>
                    <div class="user-card-info">
                        <div class="user-card-name">${escapeHtml(u.full_name || u.name) || 'Unknown'}</div>
                        <div class="user-card-detail">${escapeHtml(u.phone) || '--'}</div>
                        <div class="user-card-detail">${escapeHtml(u.village || u.location) || '--'}</div>
                        <div class="user-card-detail">Joined: ${date}</div>
                    </div>
                </div>`;
                
                // Export table row
                tableHtml += `<tr>
                    <td>${escapeHtml(u.full_name || u.name || 'Unknown')}</td>
                    <td>${escapeHtml(u.phone || '--')}</td>
                    <td>${escapeHtml(u.village || u.location || '--')}</td>
                    <td>${date}</td>
                </tr>`;
            });
            document.getElementById('usersGrid').innerHTML = html || '<p style="padding:20px;color:var(--text-muted);">No users found.</p>';
            document.getElementById('usersTableExport').innerHTML = tableHtml + '</tbody>';
        }

        // Export to Excel (CSV)
        function exportToCSV(tableId, filename) {
            let tId = tableId;
            // For grids/tables where we want custom export data
            if (tableId === 'usersGrid') tId = 'usersTableExport';
            if (tableId === 'issuesTable') tId = 'issuesTableExport';
            
            const table = document.getElementById(tId);
            if (!table) return;

            // Use querySelector to find the table element if the ID points to a wrapper
            const tableEl = table.tagName === 'TABLE' ? table : table.querySelector('table');
            if (!tableEl) {
                showToast('No data to export', 'error');
                return;
            }

            let csv = [];
            const rows = tableEl.querySelectorAll("tr");
            
            for (let i = 0; i < rows.length; i++) {
                const row = [];
                const cols = rows[i].querySelectorAll("td, th");
                
                for (let j = 0; j < cols.length; j++) {
                    // Get text, replace quotes with double quotes
                    let data = cols[j].innerText.replace(/(\r\n|\n|\r)/gm, "").replace(/"/g, '""');
                    // Check if action column (mostly empty or buttons) - skip if needed
                    if (cols[j].innerText === 'Actions' || data === 'Actions') continue;
                    if (data === 'ViewResolve' || data === 'View' || data.includes('ViewResolve')) continue;
                    
                    row.push('"' + data + '"');
                }
                if (row.length > 0) csv.push(row.join(","));
            }

            const csvFile = new Blob([csv.join("\n")], { type: "text/csv" });
            const downloadLink = document.createElement("a");
            downloadLink.download = filename + ".csv";
            downloadLink.href = window.URL.createObjectURL(csvFile);
            downloadLink.style.display = "none";
            document.body.appendChild(downloadLink);
            downloadLink.click();
            document.body.removeChild(downloadLink);
            showToast('Export downloaded');
        }

        function filterUsers() {
            const search = document.getElementById('searchUsers').value.toLowerCase();
            const filtered = allUsers.filter(u => 
                (u.full_name || '').toLowerCase().includes(search) || 
                (u.phone || '').includes(search)
            );
            renderUsers(filtered);
        }

        // Announcements
        async function loadAnnouncements() {
            debug('Loading announcements...');
            const anns = await api('/api/admin/announcements');
            if (anns && Array.isArray(anns)) {
                renderAnnouncements(anns);
            } else {
                document.getElementById('announcementsList').innerHTML = '<p style="padding:20px;color:var(--text-muted);">No announcements.</p>';
            }
        }

        function renderAnnouncements(anns) {
            let html = '';
            anns.forEach(a => {
                const date = a.created_at ? new Date(a.created_at).toLocaleDateString() : '--';
                const safeId = escapeHtml(a._id);
                html += `<div class="announcement-card">
                    <div class="announcement-content">
                        <div class="announcement-title">${escapeHtml(a.title) || 'Announcement'}</div>
                        <div class="announcement-text">${escapeHtml(a.body || a.content) || ''}</div>
                        <div class="announcement-meta">Created: ${date}</div>
                    </div>
                    <button class="action-btn delete" onclick="deleteAnnouncement('${safeId}')"><i class="fas fa-trash"></i></button>
                </div>`;
            });
            document.getElementById('announcementsList').innerHTML = html || '<p style="padding:20px;color:var(--text-muted);">No announcements yet.</p>';
        }

        function showCreateAnnouncement() {
            document.getElementById('annTitle').value = '';
            document.getElementById('annBody').value = '';
            openModal('announcementModal');
        }

        async function createAnnouncement() {
            const title = document.getElementById('annTitle').value.trim();
            const body = document.getElementById('annBody').value.trim();
            if (!title || !body) { showToast('Title and message required', 'error'); return; }
            
            const res = await api('/api/admin/announcements', {
                method: 'POST',
                body: JSON.stringify({ title, body })
            });
            
            if (res && (res.success || res._id || res.id)) {
                showToast('Announcement published!');
                closeModal('announcementModal');
                loadAnnouncements();
                loadDashboard();
            } else {
                showToast(res?.error || 'Failed to create', 'error');
            }
        }

        async function deleteAnnouncement(id) {
            if (!confirm('Delete this announcement?')) return;
            const res = await api(`/api/admin/announcements/${id}`, { method: 'DELETE' });
            if (res && res.success) {
                showToast('Announcement deleted');
                loadAnnouncements();
            } else {
                showToast(res?.error || 'Failed to delete', 'error');
            }
        }
        // Store bursaries globally for modal access
        let allBursaries = [];
        
        // Bursary
        async function loadBursaries() {
            debug('Loading bursaries...');
            const burses = await api('/api/admin/bursaries');
            if (burses && Array.isArray(burses)) {
                allBursaries = burses;
                const pending = burses.filter(b => !b.status || b.status === 'pending').length;
                const approved = burses.filter(b => b.status === 'approved').length;
                const rejected = burses.filter(b => b.status === 'rejected').length;
                document.getElementById('bursaryStats').innerHTML = `
                    <div class="stat-card"><div class="stat-value">${burses.length}</div><div class="stat-label">Total</div></div>
                    <div class="stat-card"><div class="stat-value" style="color:#f59e0b;">${pending}</div><div class="stat-label">Pending</div></div>
                    <div class="stat-card"><div class="stat-value" style="color:#10b981;">${approved}</div><div class="stat-label">Approved</div></div>
                    <div class="stat-card"><div class="stat-value" style="color:#ef4444;">${rejected}</div><div class="stat-label">Rejected</div></div>
                `;
                renderBursaries(burses);
            } else {
                document.getElementById('bursaryTable').innerHTML = '<p style="padding:20px;color:var(--text-muted);">No applications or not authorized (MCA only).</p>';
            }
        }

        function renderBursaries(burses) {
            allBursaries = burses; // Store for detail modal
            const sb = (s) => {
                if (s === 'approved') return '<span class="badge badge-resolved">Approved</span>';
                if (s === 'rejected') return '<span class="badge badge-rejected">Rejected</span>';
                return '<span class="badge badge-pending">Pending</span>';
            };
            
            // Check if user is MCA or ADMIN
            const role = currentUser?.role?.toUpperCase();
            const canAct = role === 'MCA' || role === 'ADMIN';
            
            let html = '<table><thead><tr><th>Applicant</th><th>Institution</th><th>Course</th><th>Amount</th><th>Status</th><th>Date</th><th>Actions</th></tr></thead><tbody>';
            burses.forEach(b => {
                const date = b.created_at ? new Date(b.created_at).toLocaleDateString() : '--';
                const statusLower = (b.status || 'pending').toLowerCase();
                const id = b.id || b._id || b.application_id;
                
                if (!id) console.warn('Bursary record missing ID:', b);

                let actions = '--';
                if (statusLower === 'pending') {
                    if (canAct && id) {
                         actions = `
                            <button class="action-btn approve" onclick="event.stopPropagation(); updateBursary('${id}', 'approve')" title="Approve"><i class="fas fa-check"></i></button>
                            <button class="action-btn reject" onclick="event.stopPropagation(); updateBursary('${id}', 'reject')" title="Reject"><i class="fas fa-times"></i></button>
                        `;
                    } else if (!id) {
                        actions = '<span style="color:red;font-size:11px;">Error: No ID</span>';
                    } else {
                        actions = '<span style="color:var(--text-muted);font-size:11px;">View Only</span>';
                    }
                } else if (statusLower === 'approved') {
                    actions = `<button class="action-btn" onclick="event.stopPropagation(); downloadReceipt('${id}')" title="Download Receipt"><i class="fas fa-download"></i></button>`;
                }
                
                html += `<tr onclick="showBursaryDetail('${id}')" style="cursor:pointer;">
                    <td>${escapeHtml(b.full_name || b.applicant_name || 'Unknown')}</td>
                    <td>${escapeHtml(b.institution_name || b.institution) || '--'}</td>
                    <td>${escapeHtml(b.course) || '--'}</td>
                    <td>KES ${escapeHtml(String(b.amount_requested || b.amount)) || '--'}</td>
                    <td>${sb(b.status)}</td>
                    <td>${date}</td>
                    <td>${actions}</td>
                </tr>`;
            });
            html += '</tbody></table>';
            document.getElementById('bursaryTable').innerHTML = html;
        }
        
        function showBursaryDetail(id) {
            const b = allBursaries.find(x => (x.id || x._id || x.application_id) === id);
            if (!b) return showToast('Application not found', 'error');
            
            const statusLower = (b.status || 'pending').toLowerCase();
            const statusColor = statusLower === 'approved' ? 'var(--success)' : statusLower === 'rejected' ? 'var(--error)' : 'var(--warning)';
            
            const content = `
                <div style="display:grid;gap:16px;">
                    <div style="display:flex;justify-content:space-between;align-items:center;">
                        <h3 style="margin:0;color:var(--text-light);">${escapeHtml(b.full_name || b.applicant_name || 'Unknown')}</h3>
                        <span style="background:${statusColor};color:#fff;padding:4px 12px;border-radius:12px;font-size:12px;font-weight:600;">${(b.status || 'Pending').toUpperCase()}</span>
                    </div>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
                        <div><strong style="color:var(--text-muted);font-size:12px;">Institution</strong><br>${escapeHtml(b.institution_name || '--')}</div>
                        <div><strong style="color:var(--text-muted);font-size:12px;">Course</strong><br>${escapeHtml(b.course || '--')}</div>
                        <div><strong style="color:var(--text-muted);font-size:12px;">Year of Study</strong><br>${escapeHtml(b.year_of_study || '--')}</div>
                        <div><strong style="color:var(--text-muted);font-size:12px;">Institution Type</strong><br>${escapeHtml(b.institution_type || '--')}</div>
                    </div>
                    <hr style="border-color:var(--border);">
                    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;">
                        <div><strong style="color:var(--text-muted);font-size:12px;">Has HELB?</strong><br>${b.has_helb ? ' Yes' : ' No'}</div>
                        <div><strong style="color:var(--text-muted);font-size:12px;">Has Scholarship?</strong><br>${b.has_scholarship ? ' Yes' : ' No'}</div>
                        <div><strong style="color:var(--text-muted);font-size:12px;">Fees/Semester</strong><br>KES ${b.fees_per_semester || 0}</div>
                    </div>
                    <hr style="border-color:var(--border);">
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
                        <div><strong style="color:var(--text-muted);font-size:12px;">Amount Requested</strong><br><span style="font-size:18px;font-weight:700;color:var(--primary);">KES ${b.amount_requested || 0}</span></div>
                        <div><strong style="color:var(--text-muted);font-size:12px;">Amount Approved</strong><br><span style="font-size:18px;font-weight:700;color:var(--success);">KES ${b.amount_approved || 0}</span></div>
                    </div>
                    ${b.reason ? `<div><strong style="color:var(--text-muted);font-size:12px;">Reason for Application</strong><br><p style="margin-top:4px;color:var(--text-light);">${escapeHtml(b.reason)}</p></div>` : ''}
                    ${b.admin_notes ? `<div style="background:rgba(255,140,0,0.1);padding:12px;border-radius:8px;"><strong style="color:var(--primary);font-size:12px;">Admin Notes</strong><br>${escapeHtml(b.admin_notes)}</div>` : ''}
                    ${statusLower === 'approved' ? `<button onclick="downloadReceipt('${id}')" style="background:var(--primary);color:#fff;border:none;padding:12px 24px;border-radius:8px;cursor:pointer;font-weight:600;margin-top:12px;"><i class="fas fa-download" style="margin-right:8px;"></i>Download Receipt (PDF)</button>` : ''}
                </div>
            `;
            
            showModal('Bursary Application Details', content);
        }
        
        function downloadReceipt(id) {
            const b = allBursaries.find(x => (x.id || x._id || x.application_id) === id);
            if (!b) return showToast('Application not found', 'error');
            if ((b.status || '').toLowerCase() !== 'approved') return showToast('Only approved applications can have receipts', 'error');
            
            // Load jsPDF dynamically if not loaded
            if (typeof jspdf === 'undefined') {
                const script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
                script.onload = () => generatePDF(b);
                document.head.appendChild(script);
            } else {
                generatePDF(b);
            }
        }
        
        function generatePDF(b) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Header
            doc.setFillColor(255, 140, 0);
            doc.rect(0, 0, 210, 35, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(22);
            doc.text('KYAMATU WARD', 105, 18, { align: 'center' });
            doc.setFontSize(12);
            doc.text('Bursary Approval Receipt', 105, 28, { align: 'center' });
            
            // Reset colors
            doc.setTextColor(0, 0, 0);
            
            // Applicant Info
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text('APPLICANT DETAILS', 14, 50);
            doc.setFont(undefined, 'normal');
            doc.setFontSize(11);
            doc.text(`Name: ${b.full_name || b.applicant_name || 'N/A'}`, 14, 60);
            doc.text(`Institution: ${b.institution_name || 'N/A'}`, 14, 68);
            doc.text(`Course: ${b.course || 'N/A'}`, 14, 76);
            doc.text(`Year of Study: ${b.year_of_study || 'N/A'}`, 14, 84);
            
            // Financial Info
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text('FINANCIAL DETAILS', 14, 100);
            doc.setFont(undefined, 'normal');
            doc.setFontSize(11);
            doc.text(`Amount Requested: KES ${b.amount_requested || 0}`, 14, 110);
            doc.text(`Fees per Semester: KES ${b.fees_per_semester || 0}`, 14, 118);
            doc.text(`Has HELB: ${b.has_helb ? 'Yes' : 'No'}`, 14, 126);
            doc.text(`Has Other Scholarship: ${b.has_scholarship ? 'Yes' : 'No'}`, 14, 134);
            
            // Approval Box
            doc.setFillColor(46, 204, 113);
            doc.roundedRect(14, 145, 180, 35, 3, 3, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(16);
            doc.setFont(undefined, 'bold');
            doc.text('AMOUNT APPROVED', 105, 158, { align: 'center' });
            doc.setFontSize(24);
            doc.text(`KES ${b.amount_approved || 0}`, 105, 173, { align: 'center' });
            
            // Footer
            doc.setTextColor(100, 100, 100);
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            const today = new Date().toLocaleDateString();
            doc.text(`Date of Approval: ${today}`, 14, 195);
            doc.text(`Application ID: ${b.id || b._id || 'N/A'}`, 14, 203);
            doc.text('This is an official receipt from the Kyamatu Ward Bursary Program.', 14, 220);
            
            // Signature Line
            doc.line(14, 250, 80, 250);
            doc.text('MCA Signature', 14, 258);
            doc.line(130, 250, 196, 250);
            doc.text('Ward Official Stamp', 130, 258);
            
            // Save
            doc.save(`Bursary_Receipt_${b.full_name || 'Applicant'}.pdf`);
            showToast('Receipt downloaded successfully!');
        }

        async function updateBursary(id, action) {
             if (!id || id === 'undefined') {
                showToast('Error: Invalid Application ID', 'error');
                console.error('Attempted to update bursary with undefined ID');
                return;
            }

            let body = {};
            let endpoint = '';
            
            if (action === 'approve') {
                const amount = prompt("Enter Approved Amount (KES):", "");
                if (!amount) return; // Cancelled
                body = { amount: Number(amount), notes: 'Approved via Dashboard' };
                endpoint = `/api/admin/bursaries/${id}/approve`;
            } else if (action === 'reject') {
                const reason = prompt("Enter Rejection Reason:", "Does not meet criteria");
                if (!reason) return; // Cancelled
                body = { reason: reason };
                endpoint = `/api/admin/bursaries/${id}/reject`;
            } else {
                return;
            }
            
            const res = await api(endpoint, {
                method: 'POST',
                body: JSON.stringify(body)
            });
            
            if (res && res.success) {
                showToast(`Application ${action}d successfully`);
                loadBursaries();
                loadDashboard();
            } else {
                showToast(res?.error || 'Action failed', 'error');
            }
        }
    
        // ... (previous code)

        // Subscription Logic (Suppressed)
        if ('serviceWorker' in navigator && 'PushManager' in window) {
             // ...
        }


        // Change Password
        async function changePassword() {
            const current = document.getElementById('currentPassword').value;
            const newPw = document.getElementById('newPassword').value;
            if (!current || !newPw) { showToast('Both fields required', 'error'); return; }
            
            const res = await api('/api/auth/change-password', {
                method: 'POST',
                body: JSON.stringify({ current_password: current, new_password: newPw })
            });
            
            if (res && res.success) {
                showToast('Password changed!');
                document.getElementById('currentPassword').value = '';
                document.getElementById('newPassword').value = '';
            } else {
                showToast(res?.error || 'Failed to change password', 'error');
            }
        }

        // ============ LOST IDs ============
        let allLostIds = [];
        
        async function loadLostIds() {
            debug('Loading lost IDs...');
            const res = await api('/lost-ids');
            if (res) {
                allLostIds = Array.isArray(res) ? res : (res.data || []);
            } else {
                allLostIds = [];
            }
            renderLostIds(allLostIds);
        }

        function renderLostIds(data) {
            const tbody = document.getElementById('lostIdsTable');
            if (!data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:var(--text-muted);padding:40px;">No lost ID reports found</td></tr>';
                return;
            }
            tbody.innerHTML = data.map(l => `
                <tr>
                    <td><strong>${escapeHtml(l.id_owner_name)}</strong><br><small style="color:var(--text-muted)">${l.is_for_self ? 'Self' : 'For other'}</small></td>
                    <td>${escapeHtml(l.id_number || '-')}</td>
                    <td>${escapeHtml(l.reporter_name || '-')}<br><small style="color:var(--text-muted)">${escapeHtml(l.reporter_phone || '')}</small></td>
                    <td>${escapeHtml(l.last_seen_location || '-')}</td>
                    <td>${l.date_lost || '-'}</td>
                    <td><span class="badge ${l.status === 'found' ? 'badge-resolved' : 'badge-pending'}">${(l.status || 'pending').toUpperCase()}</span></td>
                    <td>
                        <button class="action-btn approve" title="Mark as Found" onclick="markIdFound('${l.id}')"><i class="fas fa-check"></i></button>
                    </td>
                </tr>
            `).join('');
        }

        function filterLostIds() {
            const status = document.getElementById('filterLostIdStatus').value.toLowerCase();
            const search = document.getElementById('searchLostIds').value.toLowerCase();
            let filtered = allLostIds;
            if (status) filtered = filtered.filter(l => (l.status || 'pending') === status);
            if (search) filtered = filtered.filter(l => (l.id_owner_name || '').toLowerCase().includes(search) || (l.reporter_name || '').toLowerCase().includes(search));
            renderLostIds(filtered);
        }

        async function markIdFound(id) {
            if (!confirm('Mark this ID as found?')) return;
            const res = await api(`/lost-ids/${id}`, { method: 'PATCH', body: JSON.stringify({ status: 'found' }) });
            if (res?.success) {
                showToast('ID marked as found');
                loadLostIds();
            } else {
                showToast(res?.error || 'Failed to update', 'error');
            }
        }

        // ============ FEEDBACK ============
        let allFeedback = [];

        async function loadFeedback() {
            debug('Loading feedback...');
            const res = await api('/feedback');
            if (res) {
                allFeedback = Array.isArray(res) ? res : (res.data || []);
            } else {
                allFeedback = [];
            }
            renderFeedback(allFeedback);
        }

        function renderFeedback(data) {
            const tbody = document.getElementById('feedbackTable');
            if (!data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:var(--text-muted);padding:40px;">No feedback found</td></tr>';
                return;
            }
            tbody.innerHTML = data.map(f => `
                <tr>
                    <td>${escapeHtml(f.user_name || 'Anonymous')}<br><small style="color:var(--text-muted)">${escapeHtml(f.user_phone || '')}</small></td>
                    <td><span class="badge" style="background:rgba(59,130,246,0.2);color:#3b82f6;">${(f.category || 'general').toUpperCase()}</span></td>
                    <td style="max-width:250px;">${escapeHtml(f.message || '')}</td>
                    <td>${f.rating ? ''.repeat(f.rating) : '-'}</td>
                    <td><span class="badge ${f.status === 'responded' ? 'badge-resolved' : 'badge-pending'}">${(f.status || 'new').toUpperCase()}</span></td>
                    <td>${f.created_at ? new Date(f.created_at).toLocaleDateString() : '-'}</td>
                    <td>
                        <button class="action-btn view" title="View/Respond" onclick="respondFeedback('${f.id}')"><i class="fas fa-reply"></i></button>
                    </td>
                </tr>
            `).join('');
        }

        function filterFeedback() {
            const status = document.getElementById('filterFeedbackStatus').value.toLowerCase();
            const category = document.getElementById('filterFeedbackCategory').value.toLowerCase();
            let filtered = allFeedback;
            if (status) filtered = filtered.filter(f => (f.status || 'new') === status);
            if (category) filtered = filtered.filter(f => (f.category || 'general') === category);
            renderFeedback(filtered);
        }

        async function respondFeedback(id) {
            const response = prompt('Enter your response to this feedback:');
            if (!response) return;
            const res = await api(`/feedback/${id}`, { method: 'PATCH', body: JSON.stringify({ admin_response: response, status: 'responded' }) });
            if (res?.success) {
                showToast('Response sent');
                loadFeedback();
            } else {
                showToast(res?.error || 'Failed to respond', 'error');
            }
        }

        // Navigation
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', function() {
                document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
                this.classList.add('active');
                const pageId = this.dataset.page;
                document.getElementById(pageId).classList.add('active');
                
                if (pageId === 'dashboard') loadDashboard();
                if (pageId === 'issues') loadIssues();
                if (pageId === 'users') loadUsers();
                if (pageId === 'announcements') loadAnnouncements();
                if (pageId === 'bursary') loadBursaries();
                if (pageId === 'lostids') loadLostIds();
                if (pageId === 'feedback') loadFeedback();
                if (pageId === 'chat') { initChat(); clearChatBadge(); }
            });
        });

        // ============ ADMIN CHAT ============
        let chatSocket = null;
        let chatInitialized = false;
        let chatUnreadCount = 0;
        
        function updateChatBadge(add = 0) {
            chatUnreadCount += add;
            const badge = document.getElementById('chatBadge');
            if (chatUnreadCount > 0) {
                badge.textContent = chatUnreadCount > 99 ? '99+' : chatUnreadCount;
                badge.style.display = 'inline';
            } else {
                badge.style.display = 'none';
            }
        }
        
        function clearChatBadge() {
            chatUnreadCount = 0;
            updateChatBadge(0);
        }
        
        function initChat() {
            if (chatInitialized) return;
            chatInitialized = true;
            
            debug('Initializing admin chat...');
            
            // Connect to Socket.IO
            chatSocket = io(window.location.origin, {
                transports: ['websocket', 'polling']
            });
            
            chatSocket.on('connect', () => {
                debug('Chat connected: ' + chatSocket.id);
                document.getElementById('chatStatus').textContent = 'Connected';
                document.getElementById('chatStatus').style.color = 'var(--success)';
                
                // Join chat with user info
                chatSocket.emit('chat:join', {
                    username: currentUser?.username || 'admin',
                    fullName: currentUser?.fullName || currentUser?.username || 'Admin',
                    role: currentUser?.role || 'Admin'
                });
                
                // Load chat history
                loadChatHistory();
            });
            
            // Real-time data sync listeners
            chatSocket.on('data:refresh', (type) => {
                console.log('[Socket] Data refresh triggered:', type);
                switch(type) {
                    case 'issues':
                        loadDashData();
                        showToast(' Issues updated', 'info');
                        break;
                    case 'bursaries':
                        loadBursaries();
                        showToast(' Bursaries updated', 'info');
                        break;
                    case 'announcements':
                        loadAnnouncements();
                        showToast(' Announcements updated', 'info');
                        break;
                    case 'feedback':
                        loadFeedback();
                        showToast(' Feedback updated', 'info');
                        break;
                    case 'lost-ids':
                        loadLostIds();
                        showToast(' Lost IDs updated', 'info');
                        break;
                    default:
                        loadDashData();
                }
            });
            
            chatSocket.on('disconnect', () => {
                document.getElementById('chatStatus').textContent = 'Disconnected';
                document.getElementById('chatStatus').style.color = 'var(--error)';
            });
            
            // Receive messages
            chatSocket.on('chat:message', (msg) => {
                console.log('[Socket] Received message:', msg);
                try {
                    appendChatMessage(msg);
                    
                    // Show notification if message is from someone else
                    const isMe = msg.sender === (currentUser?.username || 'admin');
                    if (!isMe) {
                        // Check if on chat page
                        const chatPage = document.getElementById('chat');
                        const isOnChatPage = chatPage && chatPage.classList.contains('active');
                        
                        // Show toast notification
                        const preview = msg.text ? msg.text.substring(0, 50) : (msg.image ? ' Image' : ' Voice');
                        showToast(` ${msg.senderName}: ${preview}`, 'info');
                        
                        // Add badge if not on chat page
                        if (!isOnChatPage) {
                            updateChatBadge(1);
                        }
                        
                        // Play notification sound
                        if (typeof playNotificationSound === 'function') {
                            playNotificationSound();
                        }
                    }
                } catch (e) {
                    console.error('[Socket] Error handling message:', e);
                }
            });
            
            // Online users update
            chatSocket.on('chat:users', (users) => {
                if (typeof renderOnlineUsersWithCache === 'function') {
                    renderOnlineUsersWithCache(users);
                } else {
                    renderOnlineUsers(users);
                }
            });
            
            // Typing indicator
            chatSocket.on('chat:typing', (data) => {
                const indicator = document.getElementById('typingIndicator');
                indicator.textContent = data.isTyping ? `${data.fullName} is typing...` : '';
            });
        }
        
        async function loadChatHistory() {
            try {
                const messages = await api('/api/admin/chat/messages');
                if (Array.isArray(messages)) {
                    const container = document.getElementById('chatMessages');
                    container.innerHTML = '';
                    messages.forEach(msg => appendChatMessage(msg, false));
                    container.scrollTop = container.scrollHeight;
                }
            } catch (e) {
                debug('Failed to load chat history');
            }
        }
        
        // Generate consistent color for user
        function getUserColor(username) {
            const colors = [
                '#FF8C00', // Orange (Default)
                '#9b59b6', // Purple
                '#2ecc71', // Green
                '#e74c3c', // Red
                '#1abc9c', // Teal
                '#f39c12', // Yellow/Orange
                '#d35400', // Dark Orange
                '#3498db', // Light Blue
                '#e67e22', // Carrot
                '#8e44ad'  // Dark Purple
            ];
            let hash = 0;
            for (let i = 0; i < username.length; i++) {
                hash = username.charCodeAt(i) + ((hash << 5) - hash);
            }
            return colors[Math.abs(hash) % colors.length];
        }

        function replyToMessage(el) {
            // Get text content excluding timestamp
            let text = el.innerText;
            // Remove timestamp (last line usually)
            const lines = text.split('\n');
            if (lines.length > 1) lines.pop(); 
            text = lines.join('\n').trim();
            
            const input = document.getElementById('chatInput');
            input.value = `> "${text}"\n`;
            input.focus();
        }

        function appendChatMessage(msg, scroll = true) {
            const container = document.getElementById('chatMessages');
            const myUsername = currentUser?.username || 'admin';
            console.log('[Chat Debug] msg.sender:', msg.sender, '| myUsername:', myUsername, '| isMe:', msg.sender === myUsername);
            const isMe = msg.sender === myUsername;
            
            // Duplicate Check
            if (msg.id) {
                const existing = document.getElementById(`msg-${msg.id}`);
                if (existing) return;
            }
            
            const msgEl = document.createElement('div');
            msgEl.id = msg.id ? `msg-${msg.id}` : `temp-${Date.now()}`; 
            msgEl.className = 'message-bubble';
            msgEl.onclick = function() { replyToMessage(this); }; 
            msgEl.title = "Tap to Reply";
            
            // Color
            const bg = isMe ? '#007bff' : getUserColor(msg.sender || 'unknown');
            
            msgEl.style.cssText = `
                max-width: 70%;
                padding: 12px 16px;
                border-radius: 12px;
                margin-bottom: 10px;
                box-shadow: 0 2px 5px rgba(0,0,0,0.2);
                align-self: ${isMe ? 'flex-end' : 'flex-start'};
                background: ${bg};
                color: white;
                border-bottom-${isMe ? 'right' : 'left'}-radius: 2px;
                cursor: pointer;
            `;
            
            const time = new Date(msg.timestamp || Date.now()).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            // Build Content
            let content = '';
            
            // Header (Sender Name) if not me
            if (!isMe) {
                content += `<div style="font-size:11px;font-weight:700;margin-bottom:4px;opacity:0.9;">${escapeHtml(msg.senderName)} (${msg.senderRole || 'Admin'})</div>`;
            }
            
            // Image
            if (msg.image) {
                const imgId = msg.id ? msg.id.slice(-6) : Date.now().toString().slice(-6);
                content += `
                    <div style="margin-top:8px;">
                        <img src="${msg.image}" style="max-width:100%;max-height:200px;border-radius:8px;cursor:pointer;" onclick="window.open(this.src,'_blank'); event.stopPropagation();">
                        <div style="font-size:10px;opacity:0.7;margin-top:4px;"> ${escapeHtml(msg.senderName)}  #${imgId}</div>
                    </div>`;
            }
            
            // Voice
            if (msg.voice) {
                content += `
                    <div style="margin-top:8px; display:flex; align-items:center; gap:8px;" onclick="event.stopPropagation();">
                        <audio controls src="${msg.voice}" style="height:32px; max-width:200px;"></audio>
                        <div style="font-size:10px;opacity:0.7;"> Voice</div>
                    </div>`;
            }
            
            // Text
            if (msg.text) {
                let textHtml = escapeHtml(msg.text || '');
                // Highlight Mentions
                textHtml = textHtml.replace(/@(\w+(?:\s+\w+)?)/g, '<span style="background:rgba(255,255,255,0.2);padding:2px 4px;border-radius:4px;font-weight:700;">@$1</span>');
                // Quote styling
                textHtml = textHtml.replace(/^&gt;\s+"(.*?)"/gm, '<div style="opacity:0.7;font-style:italic;border-left:2px solid white;padding-left:8px;margin-bottom:4px;">$1</div>');
                
                content += `<div style="line-height:1.4;">${textHtml}</div>`;
            }
            
            // Time
            content += `<div style="font-size:10px;text-align:right;margin-top:4px;opacity:0.7;">${time}</div>`;
            
            msgEl.innerHTML = content;
            container.appendChild(msgEl);
            if (scroll) container.scrollTop = container.scrollHeight;
        }
        
        function renderOnlineUsers(users) {
            const container = document.getElementById('onlineUsersList');
            if (!users || users.length === 0) {
                container.innerHTML = '<div style="color:var(--text-muted);font-size:12px;">No users online</div>';
                return;
            }
            container.innerHTML = users.map(u => `
                <div style="display:flex;align-items:center;gap:8px;padding:10px;margin-bottom:6px;background:rgba(255, 255, 255, 0.05);backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,0.1);border-radius:10px;transition:all 0.2s;">
                    <div style="width:8px;height:8px;background:var(--success);border-radius:50%;box-shadow:0 0 5px var(--success);"></div>
                    <div>
                        <div style="font-size:13px;font-weight:600;color:white;">${escapeHtml(u.fullName)}</div>
                        <div style="font-size:11px;color:rgba(255,255,255,0.6);">${u.role || 'Admin'}</div>
                    </div>
                </div>
            `).join('');
        }

        
        // ============ CHAT MEDIA & MENTIONS ============
        let chatImageData = null;
        let chatVoiceData = null;
        let mediaRecorder = null;
        let audioChunks = [];
        let recordingTimer = null;
        let recordingSeconds = 0;
        let onlineUsersCache = [];
        
        // Store online users for mentions
        function renderOnlineUsersWithCache(users) {
            onlineUsersCache = users || [];
            renderOnlineUsers(users);
        }
        
        // Handle @ mentions input
        function handleChatInput(event) {
            const input = event.target;
            const value = input.value;
            const cursorPos = input.selectionStart;
            
            // Find @ before cursor
            const textBeforeCursor = value.substring(0, cursorPos);
            const atMatch = textBeforeCursor.match(/@(\w*)$/);
            
            if (atMatch) {
                const searchTerm = atMatch[1].toLowerCase();
                const filtered = onlineUsersCache.filter(u => 
                    u.fullName.toLowerCase().includes(searchTerm) || 
                    u.username.toLowerCase().includes(searchTerm)
                );
                showMentionsDropdown(filtered, atMatch.index);
            } else {
                hideMentionsDropdown();
            }
            
            // Typing indicator
            if (chatSocket) {
                chatSocket.emit('chat:typing', true);
                clearTimeout(typingTimeout);
                typingTimeout = setTimeout(() => chatSocket.emit('chat:typing', false), 1500);
            }
        }
        
        function handleChatKeydown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendChatMessage();
            }
        }
        
        function showMentionsDropdown(users, startPos) {
            const dropdown = document.getElementById('mentionsDropdown');
            if (!users.length) {
                dropdown.style.display = 'none';
                return;
            }
            dropdown.innerHTML = users.map(u => `
                <div onclick="insertMention('${escapeHtml(u.fullName)}')" style="padding:10px 12px;cursor:pointer;display:flex;align-items:center;gap:8px;border-bottom:1px solid var(--border);" onmouseover="this.style.background='var(--primary)'" onmouseout="this.style.background='transparent'">
                    <div style="width:8px;height:8px;background:var(--success);border-radius:50%;"></div>
                    <span>${escapeHtml(u.fullName)} <span style="opacity:0.6;">(${u.role})</span></span>
                </div>
            `).join('');
            dropdown.style.display = 'block';
        }
        
        function hideMentionsDropdown() {
            document.getElementById('mentionsDropdown').style.display = 'none';
        }
        
        function insertMention(name) {
            const input = document.getElementById('chatInput');
            const value = input.value;
            const cursorPos = input.selectionStart;
            const textBeforeCursor = value.substring(0, cursorPos);
            const atIndex = textBeforeCursor.lastIndexOf('@');
            
            input.value = value.substring(0, atIndex) + '@' + name + ' ' + value.substring(cursorPos);
            input.focus();
            hideMentionsDropdown();
        }
        
        // Image upload
        function handleChatImageSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                chatImageData = e.target.result;
                document.getElementById('chatPreviewImg').src = chatImageData;
                document.getElementById('chatImagePreview').style.display = 'block';
            };
            reader.readAsDataURL(file);
        }
        
        function clearChatImage() {
            chatImageData = null;
            document.getElementById('chatImagePreview').style.display = 'none';
            document.getElementById('chatImageInput').value = '';
        }
        
        // Voice recording
        async function toggleVoiceRecording() {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                stopVoiceRecording();
            } else {
                startVoiceRecording();
            }
        }
        
        async function startVoiceRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                
                mediaRecorder.ondataavailable = (e) => audioChunks.push(e.data);
                mediaRecorder.onstop = () => {
                    const blob = new Blob(audioChunks, { type: 'audio/webm' });
                    const reader = new FileReader();
                    reader.onload = () => {
                        chatVoiceData = reader.result;
                        sendChatMessage(); // Auto-send voice message
                    };
                    reader.readAsDataURL(blob);
                    stream.getTracks().forEach(t => t.stop());
                };
                
                mediaRecorder.start();
                recordingSeconds = 0;
                document.getElementById('voiceRecordingIndicator').style.display = 'block';
                document.getElementById('voiceBtn').style.background = 'var(--error)';
                recordingTimer = setInterval(() => {
                    recordingSeconds++;
                    document.getElementById('recordingTime').textContent = 
                        Math.floor(recordingSeconds/60) + ':' + String(recordingSeconds%60).padStart(2,'0');
                }, 1000);
            } catch (e) {
                showToast('Microphone access denied', 'error');
            }
        }
        
        function stopVoiceRecording() {
            if (mediaRecorder) {
                mediaRecorder.stop();
                clearInterval(recordingTimer);
                document.getElementById('voiceRecordingIndicator').style.display = 'none';
                document.getElementById('voiceBtn').style.background = 'var(--border)';
            }
        }
        
        let typingTimeout = null;
        async function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const text = input.value.trim();
            
            // Must have text, image, or voice
            if (!text && !chatImageData && !chatVoiceData) return;
            if (!chatSocket) return;
            
            const messageData = { text: text || '' };
            
            // Add image if present
            if (chatImageData) {
                messageData.image = chatImageData;
                clearChatImage();
            }
            
            // Add voice if present
            if (chatVoiceData) {
                messageData.voice = chatVoiceData;
                chatVoiceData = null;
            }
            
            // OPTIMISTIC UPDATE: Show message immediately
            const pendingMsg = {
                id: Date.now().toString(), // Temp ID
                sender: currentUser?.username || 'admin',
                senderName: currentUser?.fullName || 'Me',
                senderRole: currentUser?.role || 'Admin',
                ...messageData,
                timestamp: new Date().toISOString()
            };
            appendChatMessage(pendingMsg); 
            
            chatSocket.emit('chat:message', messageData);
            input.value = '';
            hideMentionsDropdown();
        }
        
        // NOTIFICATION SOUND (iPhone 'Note' style)
        const notifSound = new Audio("data:audio/mp3;base64,SUQzBAAAAAABAFRYVFgAAAASAAADbWFqb3JfYnJhbmQAbXA0MgBUWFRYAAAAEQAAA21pbm9yX3ZlcnNpb24AMABUWFRYAAAAHAAAA2NvbXBhdGlibGVfYnJhbmRzAGlzb21tcDQyAFRTU0UAAAAOAAADTGF2ZjU3LjU2LjEwMAAAAAAAAAAAAAAA//uQZAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAWgAAAA0AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//uQZAAABhgLVu08AIAAAAA0gAAABP4Fv8s4AAgAAAA0gAAABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAv/7kGQADH/AAABAAAAAABAAQAAACAAeAs/2qgACAAAA0gAAABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//uQZAAACfsDAAAAAAIAAAA0gAAABXUA8esbQAAgAAAA0gAAABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//uQZAAACtsDLesbQAAgAAAA0gAAABhYDcesbQAAgAAAA0gAAABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//uQZAAAC8MDM+sbQAAgAAAA0gAAABjwMxesbQAAgAAAA0gAAABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//uQZAAADSMDM+sbQAAgAAAA0gAAABmwMyesbQAAgAAAA0gAAABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//uQZAAADeMDM+sbQAAgAAAA0gAAABqAMyesbQAAgAAAA0gAAABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//uQZAAADiMDMesbQAAgAAAA0gAAABtQMxesbQAAgAAAA0gAAABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//uQZAAADmMDM+sbQAAgAAAA0gAAABwwMxesbQAAgAAAA0gAAABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//uQZAAADpMDMesbQAAgAAAA0gAAAB0QMyesbQAAgAAAA0gAAABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA");
        
        function playNotificationSound() {
            notifSound.currentTime = 0; // Reset to start
            notifSound.volume = 1.0;
            notifSound.play().catch(e => console.warn('Audio play blocked:', e));
        }

        // Initialize
        debug('Initializing dashboard...');
        
        // Check auth - Use 'authToken' which is set by login page
        const token = localStorage.getItem('authToken');
        if (!token) {
            window.location.href = '/login.html';
        } else {
            loadUserInfo();
            loadDashboard();
            
            // Setup mobile toggle
            const mobileBtn = document.getElementById('mobileMenuBtn');
            if (mobileBtn) {
                mobileBtn.addEventListener('click', function() {
                    document.querySelector('.sidebar').classList.toggle('active');
                });
            }
            
            // Handle URL Params (Auto-Nav & Prefill)
            setTimeout(() => {
                const urlParams = new URLSearchParams(window.location.search);
                const tab = urlParams.get('tab');
                const msg = urlParams.get('msg');
                const prefill = urlParams.get('prefill'); // Alias
                
                if (tab) {
                    const navItem = document.querySelector(`.nav-item[data-page="${tab}"]`);
                    if (navItem) {
                        console.log('Auto-switching to tab:', tab);
                        navItem.click();
                        
                        // Handle Chat Prefill
                        if (tab === 'chat' && (msg || prefill)) {
                            const input = document.getElementById('chatInput');
                            if (input) {
                                input.value = (msg || prefill) + " ";
                                input.focus();
                            }
                        }
                    }
                }
            }, 500); // Slight delay to ensure listeners are bound
            
            // Register SW for Push
            if ('serviceWorker' in navigator && 'PushManager' in window) {
                navigator.serviceWorker.register('/sw.js')
                .then(function(reg) {
                    console.log('Service Worker Registered');
                    initPushSubscription(reg);
                })
                .catch(function(error) {
                    console.error('Service Worker Error', error);
                });
            }
        }

        // Push Notifications Helpers
        const VAPID_PUBLIC_KEY = 'BP7y19LgF44ujdMW01ByyX8pZ6sCFbvZvIDtmjsoCWyVBZIdMQlTb4e5oDroRQayBVvH4yyoLbBHKa_kyl4uKUs';

        function urlBase64ToUint8Array(base64String) {
            const padding = '='.repeat((4 - base64String.length % 4) % 4);
            const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
            const rawData = window.atob(base64);
            const outputArray = new Uint8Array(rawData.length);
            for (let i = 0; i < rawData.length; ++i) {
                outputArray[i] = rawData.charCodeAt(i);
            }
            return outputArray;
        }

        async function initPushSubscription(reg) {
            try {
                let sub = await reg.pushManager.getSubscription();
                if (!sub) {
                    const publicKey = urlBase64ToUint8Array(VAPID_PUBLIC_KEY);
                    sub = await reg.pushManager.subscribe({
                        userVisibleOnly: true,
                        applicationServerKey: publicKey
                    });
                }
                sendSubscriptionToServer(sub);
            } catch (err) {
                console.error('Failed to subscribe user: ', err);
            }
        }
        
        async function sendSubscriptionToServer(sub) {
            if (!currentUser) return;
            try {
                await api('/api/notifications/subscribe', {
                    method: 'POST',
                    body: JSON.stringify({ subscription: sub, username: currentUser.username })
                });
            } catch (e) {
                console.error('Failed to save subscription', e);
            }
        }
    </script>
</body>
</html>
