# Architecture Overview - Enhanced USSD System

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Africa's Talking                              â”‚
â”‚                    *384*8481# (USSD Gateway)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚ POST /ussd
                                â”‚ phoneNumber, text, sessionId
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Fastify Backend                               â”‚
â”‚                     (Port 4000, Pino Logger)                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  1. MIDDLEWARE PIPELINE                                     â”‚   â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                  â”‚   â”‚
â”‚  â”‚  â€¢ CORS Headers (wildcard)                                  â”‚   â”‚
â”‚  â”‚  â€¢ Form-URL-Encoded Parser (@fastify/formbody)              â”‚   â”‚
â”‚  â”‚  â€¢ Rate Limiter (phone: 30/5min, session: 20/2min) âœ¨      â”‚   â”‚
â”‚  â”‚  â€¢ Signature Verifier (HMAC, optional) âœ¨                   â”‚   â”‚
â”‚  â”‚  â€¢ Metrics Counter (requests_total++) âœ¨                    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  2. ROUTING LAYER                                           â”‚   â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                             â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚  Public Endpoints:                                          â”‚   â”‚
â”‚  â”‚  â”œâ”€ GET  /health           â†’ Health check                  â”‚   â”‚
â”‚  â”‚  â”œâ”€ POST /ussd             â†’ USSD handler (rate-limited)   â”‚   â”‚
â”‚  â”‚  â”œâ”€ GET  /metrics âœ¨       â†’ System stats (new)           â”‚   â”‚
â”‚  â”‚  â””â”€ POST /auth/login       â†’ JWT authentication            â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚  Admin Endpoints (X-ADMIN-KEY required):                    â”‚   â”‚
â”‚  â”‚  â”œâ”€ GET  /admin/exports/members.json?q=john&from=... âœ¨   â”‚   â”‚
â”‚  â”‚  â”œâ”€ GET  /admin/exports/bursaries.csv?area_id=5 âœ¨        â”‚   â”‚
â”‚  â”‚  â”œâ”€ POST /admin/areas/refresh âœ¨                           â”‚   â”‚
â”‚  â”‚  â””â”€ (existing JWT-protected admin routes)                  â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚  Protected Endpoints (JWT required):                        â”‚   â”‚
â”‚  â”‚  â”œâ”€ GET/POST/DELETE /announcements                          â”‚   â”‚
â”‚  â”‚  â”œâ”€ GET/POST/PATCH  /issues                                 â”‚   â”‚
â”‚  â”‚  â”œâ”€ GET/POST/DELETE /admin/users                            â”‚   â”‚
â”‚  â”‚  â””â”€ GET/PATCH       /citizen/messages                       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  3. SERVICES LAYER âœ¨                                       â”‚   â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                        â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚  â€¢ i18n Service                                             â”‚   â”‚
â”‚  â”‚    â”œâ”€ getDict(lang) â†’ Returns EN or SW dictionary          â”‚   â”‚
â”‚  â”‚    â”œâ”€ MAIN: "Welcome to Kyamatu..." / "Karibu..."          â”‚   â”‚
â”‚  â”‚    â”œâ”€ LANG: "1.English 2.Kiswahili"                        â”‚   â”‚
â”‚  â”‚    â””â”€ HINT: "0:Back 00:Home"                                â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚  â€¢ Session Store (LRU Cache)                                â”‚   â”‚
â”‚  â”‚    â”œâ”€ Capacity: 10,000 sessions                             â”‚   â”‚
â”‚  â”‚    â”œâ”€ TTL: 10 minutes                                       â”‚   â”‚
â”‚  â”‚    â””â”€ Used for: Multi-step USSD flows                       â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚  â€¢ Areas Cache                                              â”‚   â”‚
â”‚  â”‚    â”œâ”€ TTL: 10 minutes                                       â”‚   â”‚
â”‚  â”‚    â”œâ”€ Auto-refresh on miss                                  â”‚   â”‚
â”‚  â”‚    â””â”€ Manual: POST /admin/areas/refresh                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  4. DATABASE LAYER                                          â”‚   â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                            â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚  PostgreSQL (pg.Client)                                     â”‚   â”‚
â”‚  â”‚  postgresql://localhost:5432/voo_db                         â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚  Tables:                                                     â”‚   â”‚
â”‚  â”‚  â”œâ”€ constituents (8-digit ID, 3-part names, area+village)  â”‚   â”‚
â”‚  â”‚  â”œâ”€ bursary_applications                                    â”‚   â”‚
â”‚  â”‚  â”œâ”€ issues (community reports)                              â”‚   â”‚
â”‚  â”‚  â”œâ”€ areas (wards/villages)                                  â”‚   â”‚
â”‚  â”‚  â”œâ”€ preferences (phone â†’ lang) âœ¨ NEW                      â”‚   â”‚
â”‚  â”‚  â”œâ”€ audit_events (with new indexes) âœ¨                     â”‚   â”‚
â”‚  â”‚  â”œâ”€ announcements                                           â”‚   â”‚
â”‚  â”‚  â”œâ”€ admin_users                                             â”‚   â”‚
â”‚  â”‚  â””â”€ citizen_messages                                        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        USSD FLOW EXAMPLE                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  User dials: *384*8481#                                             â”‚
â”‚                                                                      â”‚
â”‚  1ï¸âƒ£ Main Menu (language-aware):                                    â”‚
â”‚     CON Welcome to Kyamatu Ward                                     â”‚
â”‚     1. Register                                                      â”‚
â”‚     2. Apply for Bursary                                            â”‚
â”‚     3. Report Issue                                                  â”‚
â”‚     4. View Projects                                                â”‚
â”‚     7. Change Language âœ¨                                           â”‚
â”‚     0:Back 00:Home âœ¨                                               â”‚
â”‚                                                                      â”‚
â”‚  User presses: 7 (Change Language)                                  â”‚
â”‚                                                                      â”‚
â”‚  2ï¸âƒ£ Language Menu:                                                 â”‚
â”‚     CON Select Language / Chagua Lugha                              â”‚
â”‚     1. English                                                       â”‚
â”‚     2. Kiswahili                                                     â”‚
â”‚     0:Back 00:Home                                                   â”‚
â”‚                                                                      â”‚
â”‚  User presses: 2 (Kiswahili)                                        â”‚
â”‚                                                                      â”‚
â”‚  3ï¸âƒ£ Confirmation:                                                  â”‚
â”‚     END Lugha imewekwa Kiswahili                                    â”‚
â”‚     (Language set to Swahili)                                       â”‚
â”‚                                                                      â”‚
â”‚  Database Update:                                                    â”‚
â”‚  INSERT INTO preferences (phone, lang) VALUES ('254712...', 'SW')  â”‚
â”‚  ON CONFLICT (phone) DO UPDATE SET lang='SW'                        â”‚
â”‚                                                                      â”‚
â”‚  Next Session: All menus display in Swahili automatically           â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        RATE LIMITING FLOW                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  Request 1-30:  âœ… Pass through                                     â”‚
â”‚  Request 31:    ğŸ›‘ "END Too many requests. Try again later."        â”‚
â”‚                                                                      â”‚
â”‚  Limits:                                                             â”‚
â”‚  â€¢ Phone:   30 requests per 5 minutes (RATE_LIMIT_MAX)             â”‚
â”‚  â€¢ Session: 20 steps per 2 minutes (prevents infinite loops)       â”‚
â”‚                                                                      â”‚
â”‚  Storage: In-memory Map with auto-cleanup                           â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ADMIN EXPORT FLOW                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  Request:                                                            â”‚
â”‚  GET /admin/exports/members.json?q=john&from=2025-01-01&area_id=5  â”‚
â”‚  Header: X-ADMIN-KEY: kyamatu-secure-2024                           â”‚
â”‚                                                                      â”‚
â”‚  Response:                                                           â”‚
â”‚  [                                                                   â”‚
â”‚    {                                                                 â”‚
â”‚      "id": 12345678,                                                â”‚
â”‚      "full_name": "John Kamau Mwangi",                              â”‚
â”‚      "area_name": "Kyamatu Market",                                 â”‚
â”‚      "village": "Kambi ya Sungura",                                 â”‚
â”‚      "phone": "254712345678",                                        â”‚
â”‚      "created_at": "2025-01-15T10:30:00Z"                           â”‚
â”‚    }                                                                 â”‚
â”‚  ]                                                                   â”‚
â”‚                                                                      â”‚
â”‚  Filters Applied:                                                    â”‚
â”‚  â€¢ Text search: "john" in name/phone/village                        â”‚
â”‚  â€¢ Date range: >= 2025-01-01                                        â”‚
â”‚  â€¢ Area: area_id = 5                                                â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        METRICS ENDPOINT                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  GET /metrics                                                        â”‚
â”‚                                                                      â”‚
â”‚  {                                                                   â”‚
â”‚    "uptime_seconds": 3600,                                          â”‚
â”‚    "requests_total": 450,        â† Incremented on each /ussd call  â”‚
â”‚    "ussd_active_sessions": 12,   â† From session store              â”‚
â”‚    "registrations_total": 35,    â† App-level counter               â”‚
â”‚    "applications_total": 18,     â† App-level counter               â”‚
â”‚    "issues_total": 7,            â† App-level counter               â”‚
â”‚    "rate_limited_total": 3,      â† Blocked request counter         â”‚
â”‚    "timestamp": "2025-05-15T10:30:00.000Z"                          â”‚
â”‚  }                                                                   â”‚
â”‚                                                                      â”‚
â”‚  Use for: Monitoring, alerts, dashboards                            â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        DEPLOYMENT FLOW                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  Windows (Your PC):                                                  â”‚
â”‚  â”œâ”€ Package ready: deploy-package/ (0.2 MB)                        â”‚
â”‚  â”œâ”€ Guide: QUICK_START.md                                           â”‚
â”‚  â””â”€ Upload: scp -r deploy-package root@your-server:/opt/ussd       â”‚
â”‚                                                                      â”‚
â”‚  Ubuntu Server (DigitalOcean):                                      â”‚
â”‚  â”œâ”€ Install: Node.js 20.x, PostgreSQL 16, PM2                      â”‚
â”‚  â”œâ”€ Setup: Database, migrations, .env                               â”‚
â”‚  â”œâ”€ Start: pm2 start src/index.js --name ussd                      â”‚
â”‚  â””â”€ Monitor: pm2 logs ussd                                          â”‚
â”‚                                                                      â”‚
â”‚  Africa's Talking:                                                   â”‚
â”‚  â”œâ”€ Apply for USSD code (e.g., *384*8481#)                         â”‚
â”‚  â”œâ”€ Set webhook: https://your-server.com/ussd                      â”‚
â”‚  â””â”€ Test on simulator first                                         â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        SECURITY LAYERS                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  Layer 1: Rate Limiting                                             â”‚
â”‚  â”œâ”€ Prevents: DoS, spam, infinite loops                             â”‚
â”‚  â””â”€ Config: RATE_LIMIT_MAX, RATE_LIMIT_WINDOW_MS                   â”‚
â”‚                                                                      â”‚
â”‚  Layer 2: Admin Key Authentication                                  â”‚
â”‚  â”œâ”€ Protects: /admin/* endpoints                                    â”‚
â”‚  â”œâ”€ Header: X-ADMIN-KEY                                             â”‚
â”‚  â””â”€ Config: ADMIN_EXPORT_KEY in .env                                â”‚
â”‚                                                                      â”‚
â”‚  Layer 3: JWT Authentication (existing)                             â”‚
â”‚  â”œâ”€ Protects: Web dashboard endpoints                               â”‚
â”‚  â”œâ”€ Header: Authorization: Bearer <token>                           â”‚
â”‚  â””â”€ Config: JWT_SECRET in .env                                      â”‚
â”‚                                                                      â”‚
â”‚  Layer 4: HMAC Signature (optional)                                 â”‚
â”‚  â”œâ”€ Verifies: Requests from Africa's Talking                        â”‚
â”‚  â”œâ”€ Config: VERIFY_SIGNATURE=true, AT_API_KEY                      â”‚
â”‚  â””â”€ Enable in production                                            â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


âœ¨ = New Enhanced Feature
```

## Key Files

```
backend/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ index.js                    â† Enhanced entry point
â”‚   â”œâ”€â”€ routes/
â”‚   â”‚   â”œâ”€â”€ ussd.js                 â† TODO: Add Option 7 + hints
â”‚   â”‚   â”œâ”€â”€ metrics.js âœ¨           â† New: System stats
â”‚   â”‚   â””â”€â”€ adminAreas.js âœ¨        â† New: Cache management
â”‚   â”œâ”€â”€ middleware/
â”‚   â”‚   â”œâ”€â”€ rateLimit.js âœ¨         â† Rate limiting logic
â”‚   â”‚   â”œâ”€â”€ signature.js âœ¨         â† HMAC verification
â”‚   â”‚   â””â”€â”€ adminKey.js âœ¨          â† X-ADMIN-KEY check
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”œâ”€â”€ i18n.js âœ¨              â† EN/SW dictionaries
â”‚   â”‚   â”œâ”€â”€ sessionStore.js âœ¨      â† LRU cache
â”‚   â”‚   â””â”€â”€ areasCache.js âœ¨        â† Cached areas
â”‚   â””â”€â”€ db/
â”‚       â””â”€â”€ migrations/
â”‚           â”œâ”€â”€ 001_preferences.sql âœ¨
â”‚           â””â”€â”€ 002_audit_index.sql âœ¨
â”œâ”€â”€ .env                            â† Updated with new vars
â”œâ”€â”€ setup.ps1 âœ¨                    â† One-click setup
â”œâ”€â”€ run-migrations.ps1 âœ¨           â† DB migration runner
â”œâ”€â”€ run-migrations.ps1              â† Database migrations
â”œâ”€â”€ SETUP_GUIDE.md âœ¨               â† Quick reference
â””â”€â”€ FASTIFY_INTEGRATION.md âœ¨       â† Technical docs
```

## Production Checklist

- [ ] `.\setup.ps1` - One-click setup
- [ ] Verify metrics: `Invoke-RestMethod http://localhost:4000/metrics`
- [ ] Verify health: `Invoke-RestMethod http://localhost:4000/health`
- [ ] Update USSD handler for Option 7
- [ ] Change ADMIN_EXPORT_KEY to strong value
- [ ] Deploy to DigitalOcean (follow QUICK_START.md)

---

**Status:** Integration complete, ready for production!
