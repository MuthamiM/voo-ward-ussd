<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>USSD Simulator - Feature Phone</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
      * { box-sizing: border-box; margin: 0; padding: 0; }
      body {
        font-family: 'Courier New', monospace;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
      }
      .phone-container {
        background: #2a2a2a;
        border-radius: 30px;
        padding: 25px 20px;
        width: 100%;
        max-width: 380px;
        box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        border: 3px solid #1a1a1a;
      }
      .brand {
        text-align: center;
        color: #888;
        font-size: 12px;
        margin-bottom: 15px;
        letter-spacing: 2px;
      }
      .screen {
        background: #9cb896;
        border: 3px solid #1a1a1a;
        border-radius: 8px;
        padding: 15px;
        min-height: 200px;
        margin-bottom: 20px;
        font-family: 'Courier New', monospace;
        font-size: 14px;
        line-height: 1.6;
        color: #000;
        position: relative;
        box-shadow: inset 0 2px 10px rgba(0,0,0,0.3);
      }
      .screen-content {
        white-space: pre-wrap;
        word-wrap: break-word;
      }
      .input-area {
        background: #3a3a3a;
        padding: 12px;
        border-radius: 8px;
        margin-bottom: 15px;
      }
      .input-display {
        background: #555;
        color: #0f0;
        padding: 10px;
        border-radius: 4px;
        font-family: 'Courier New', monospace;
        font-size: 16px;
        min-height: 40px;
        border: 2px solid #444;
      }
      .keypad {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 10px;
        margin-bottom: 15px;
      }
      .key {
        background: linear-gradient(to bottom, #4a4a4a, #2a2a2a);
        border: 2px solid #1a1a1a;
        border-radius: 8px;
        padding: 15px;
        font-size: 20px;
        font-weight: bold;
        color: #fff;
        cursor: pointer;
        text-align: center;
        transition: all 0.1s;
        box-shadow: 0 4px 0 #1a1a1a;
      }
      .key:active {
        transform: translateY(2px);
        box-shadow: 0 2px 0 #1a1a1a;
      }
      .key.special {
        font-size: 14px;
      }
      .action-buttons {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
      }
      .action-btn {
        background: linear-gradient(to bottom, #4CAF50, #2E7D32);
        border: 2px solid #1a5a1a;
        border-radius: 8px;
        padding: 15px;
        font-size: 14px;
        font-weight: bold;
        color: #fff;
        cursor: pointer;
        text-transform: uppercase;
        box-shadow: 0 4px 0 #1a5a1a;
        transition: all 0.1s;
      }
      .action-btn:active {
        transform: translateY(2px);
        box-shadow: 0 2px 0 #1a5a1a;
      }
      .action-btn.reset {
        background: linear-gradient(to bottom, #f44336, #c62828);
        border-color: #8b0000;
        box-shadow: 0 4px 0 #8b0000;
      }
      .status-bar {
        text-align: center;
        color: #888;
        font-size: 11px;
        margin-top: 15px;
        padding-top: 10px;
        border-top: 1px solid #444;
      }
      .loading {
        display: none;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: #000;
        font-weight: bold;
      }
      .helper {
        background: #1a1a1a;
        color: #888;
        padding: 10px;
        border-radius: 8px;
        margin-bottom: 15px;
        font-size: 11px;
        text-align: center;
        line-height: 1.4;
      }
      .helper strong {
        color: #4CAF50;
      }
      .clear-btn {
        background: linear-gradient(to bottom, #ff9800, #e65100);
        border: 2px solid #bf360c;
        box-shadow: 0 4px 0 #bf360c;
      }
    </style>
  </head>
  <body>
    <div class="phone-container">
      <div class="brand">KYAMATU WARD USSD</div>
      
      <div class="screen">
        <div class="screen-content" id="output">Dial *384*44647# to start...</div>
        <div class="loading" id="loading">Loading...</div>
      </div>
      
      <div class="helper">
        <strong>T9 Input:</strong> Press number keys repeatedly to type letters<br>
        Example: Press <strong>4-4-4</strong> for "i", <strong>2-2-2-2</strong> for "2"
      </div>
      
      <div class="input-area">
        <div class="input-display" id="input"></div>
      </div>
      
      <div class="keypad">
        <button class="key" onclick="addDigit('1')">1</button>
        <button class="key" onclick="addDigit('2')">2<br><small>ABC</small></button>
        <button class="key" onclick="addDigit('3')">3<br><small>DEF</small></button>
        <button class="key" onclick="addDigit('4')">4<br><small>GHI</small></button>
        <button class="key" onclick="addDigit('5')">5<br><small>JKL</small></button>
        <button class="key" onclick="addDigit('6')">6<br><small>MNO</small></button>
        <button class="key" onclick="addDigit('7')">7<br><small>PQRS</small></button>
        <button class="key" onclick="addDigit('8')">8<br><small>TUV</small></button>
        <button class="key" onclick="addDigit('9')">9<br><small>WXYZ</small></button>
        <button class="key special" onclick="addDigit('*')">*</button>
        <button class="key" onclick="addDigit('0')">0<br><small>+</small></button>
        <button class="key special" onclick="addDigit('#')">#</button>
      </div>
      
      <div class="action-buttons">
        <button class="action-btn clear-btn" onclick="backspace()">CLEAR</button>
        <button class="action-btn" onclick="sendUSSD()">SEND</button>
      </div>
      <div class="action-buttons" style="margin-top: 10px;">
        <button class="action-btn reset" onclick="resetSession()" style="grid-column: 1 / -1;">RESET SESSION</button>
      </div>
      
      <div class="status-bar">
        Session: <span id="session">IDLE</span> | Phone: +254700000000
      </div>
    </div>

    <script>
      let currentInput = '';
      let sessionId = 'SIM-' + Date.now();
      let ussdPath = [];
      let lastKey = '';
      let lastKeyTime = 0;
      let keyPressCount = 0;
      
      // T9 key mappings (like old Nokia phones)
      const t9Map = {
        '2': ['a', 'b', 'c', '2'],
        '3': ['d', 'e', 'f', '3'],
        '4': ['g', 'h', 'i', '4'],
        '5': ['j', 'k', 'l', '5'],
        '6': ['m', 'n', 'o', '6'],
        '7': ['p', 'q', 'r', 's', '7'],
        '8': ['t', 'u', 'v', '8'],
        '9': ['w', 'x', 'y', 'z', '9'],
        '0': [' ', '0']
      };

      function addDigit(digit) {
        const now = Date.now();
        
        // Check if this is a T9 key (2-9, 0)
        if (t9Map[digit]) {
          // If same key pressed within 1 second, cycle through letters
          if (lastKey === digit && (now - lastKeyTime) < 1000) {
            // Remove last character and cycle to next letter
            currentInput = currentInput.slice(0, -1);
            keyPressCount = (keyPressCount + 1) % t9Map[digit].length;
          } else {
            // New key or timeout, start fresh
            keyPressCount = 0;
            lastKey = digit;
          }
          
          currentInput += t9Map[digit][keyPressCount];
          lastKeyTime = now;
        } else {
          // Direct input for * and #
          currentInput += digit;
          lastKey = '';
          keyPressCount = 0;
        }
        
        document.getElementById('input').textContent = currentInput;
      }

      function backspace() {
        if (currentInput.length > 0) {
          currentInput = currentInput.slice(0, -1);
          document.getElementById('input').textContent = currentInput;
          lastKey = '';
          keyPressCount = 0;
        }
      }

      function clearInput() {
        currentInput = '';
        lastKey = '';
        keyPressCount = 0;
        document.getElementById('input').textContent = '';
      }

      async function sendUSSD() {
        const input = currentInput.trim();
        
        // If input has digits, add to path
        if (input && !input.includes('*') && !input.includes('#')) {
          ussdPath.push(input);
        }
        
        // Build text from path
        const text = ussdPath.join('*');
        
        // Show loading
        document.getElementById('loading').style.display = 'block';
        document.getElementById('session').textContent = 'ACTIVE';
        
        try {
          const body = new URLSearchParams({
            sessionId: sessionId,
            serviceCode: '*384*44647#',
            phoneNumber: '+254700000000',
            text: text
          });
          
          const res = await fetch('/ussd', { 
            method: 'POST', 
            headers: {'Content-Type': 'application/x-www-form-urlencoded'}, 
            body 
          });
          
          const response = await res.text();
          document.getElementById('output').textContent = response;
          
          // If END, reset path
          if (response.startsWith('END')) {
            ussdPath = [];
            document.getElementById('session').textContent = 'ENDED';
            setTimeout(() => {
              document.getElementById('session').textContent = 'IDLE';
            }, 2000);
          }
          
        } catch (error) {
          document.getElementById('output').textContent = 'ERROR: Cannot connect to USSD service';
        } finally {
          document.getElementById('loading').style.display = 'none';
          clearInput();
        }
      }

      function resetSession() {
        ussdPath = [];
        sessionId = 'SIM-' + Date.now();
        currentInput = '';
        document.getElementById('input').textContent = '';
        document.getElementById('output').textContent = 'Dial *384*44647# to start...';
        document.getElementById('session').textContent = 'IDLE';
      }

      // Allow Enter key to send
      document.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          sendUSSD();
        } else if (e.key >= '0' && e.key <= '9') {
          addDigit(e.key);
        } else if (e.key === '*' || e.key === '#') {
          addDigit(e.key);
        }
      });

      // Auto-start on load
      window.addEventListener('load', () => {
        setTimeout(() => sendUSSD(), 500);
      });
    </script>
  </body>
</html>
